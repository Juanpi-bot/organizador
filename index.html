<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#004D98">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Barça Organizer Ultimate</title>
    
    <link rel="manifest" id="my-manifest">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        @media print { body { -webkit-print-color-adjust: exact; } }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .prevent-select { -webkit-user-select: none; user-select: none; -webkit-tap-highlight-color: transparent; }
        @keyframes slideUp { from { transform: translateY(100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .toast-animate { animation: slideUp 0.3s cubic-bezier(0.18, 0.89, 0.32, 1.28) forwards; }
        .h-dvh { height: 100vh; height: 100dvh; }
        
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
            -webkit-appearance: none; 
            margin: 0; 
        }
    </style>

    <!-- Script PWA -->
    <script>
        const iconSvg = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><rect width="512" height="512" fill="#004D98"/><path d="M0 0h512v150H0z" fill="#004D98"/><path d="M0 150h512v362H0z" fill="#A50044"/><path d="M256 200l-50 150h100z" fill="#EDBB00"/><text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" font-family="Arial" font-size="250" font-weight="bold" fill="#EDBB00">B</text></svg>`;
        const iconUrl = 'data:image/svg+xml;base64,' + btoa(iconSvg);
        const manifest = { "name": "Barça Organizer", "short_name": "BarçaOrg", "start_url": ".", "display": "standalone", "background_color": "#121212", "theme_color": "#004D98", "orientation": "portrait", "icons": [{ "src": iconUrl, "sizes": "512x512", "type": "image/svg+xml" }] };
        document.getElementById('my-manifest').href = URL.createObjectURL(new Blob([JSON.stringify(manifest)], {type: 'application/json'}));
        
        if ('serviceWorker' in navigator) {
            const swCode = `
                self.addEventListener('install', (e) => self.skipWaiting());
                self.addEventListener('activate', (e) => self.clients.claim());
                self.addEventListener('notificationclick', (e) => {
                    e.notification.close();
                    e.waitUntil(clients.matchAll({type: 'window'}).then(clientsArr => {
                        if (clientsArr.length > 0) clientsArr[0].focus();
                    }));
                });
            `;
            navigator.serviceWorker.register(URL.createObjectURL(new Blob([swCode], {type: 'application/javascript'}))).catch(console.log);
        }
    </script>
</head>
<body class="bg-gray-900 text-gray-100 overflow-hidden select-none touch-manipulation">
    
    <div id="root"></div>

    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
            "lucide-react": "https://esm.sh/lucide-react@0.292.0"
        }
    }
    </script>

    <script type="module">
        import React, { useState, useEffect, useRef } from 'react';
        import { createRoot } from 'react-dom/client';
        import { 
            Truck, ShoppingCart, CheckSquare, Package, 
            Plus, Trash2, Download, Upload, 
            ArrowUp, ArrowDown, Archive, RotateCcw, 
            AlertCircle, X, Store, User, ArrowRight, Home,
            ArrowRightLeft, CircleSlash, Pencil,
            Settings, Save, History, Calendar, TrendingDown,
            Clock, ChevronRight, FileText, Printer, Star, GripVertical, AlertTriangle, DollarSign, ListFilter, Check, Repeat, Bell, BellRing
        } from 'lucide-react';

        function App() {
            // --- Estados ---
            const [activeTab, setActiveTab] = useState(3); 
            const [items, setItems] = useState([]);
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [showBodega, setShowBodega] = useState(false);
            const [showSettings, setShowSettings] = useState(false);
            const [editingItem, setEditingItem] = useState(null); 
            const [reorderModeId, setReorderModeId] = useState(null);
            const [sortBy, setSortBy] = useState('manual'); 
            const [sortDir, setSortDir] = useState('asc'); 
            const [showSortMenu, setShowSortMenu] = useState(false);
            const [itemToDelete, setItemToDelete] = useState(null);
            const [toastMessage, setToastMessage] = useState(null);

            // Modales Extra
            const [isConsumeModalOpen, setIsConsumeModalOpen] = useState(false);
            const [consumeItem, setConsumeItem] = useState(null);
            const [consumeQty, setConsumeQty] = useState('');
            const [consumeLocation, setConsumeLocation] = useState('Sara');
            const [isHistoryModalOpen, setIsHistoryModalOpen] = useState(false);
            const [historyItem, setHistoryItem] = useState(null);
            const [isReportModalOpen, setIsReportModalOpen] = useState(false);
            const [reportStartDate, setReportStartDate] = useState('');
            const [reportEndDate, setReportEndDate] = useState('');

            // Formulario
            const [newItemText, setNewItemText] = useState('');
            const [newItemPriority, setNewItemPriority] = useState('none');
            const [newItemQuantity, setNewItemQuantity] = useState(''); 
            const [newItemFrom, setNewItemFrom] = useState('Sara'); 
            const [newItemTo, setNewItemTo] = useState('Negocio');
            const [newItemContext, setNewItemContext] = useState('-'); 
            const [addToInventory, setAddToInventory] = useState(false);
            const [newItemPrice, setNewItemPrice] = useState('');
            const [newItemDate, setNewItemDate] = useState('');
            const [newItemRecurrence, setNewItemRecurrence] = useState([]);
            const [newItemAlarmEnabled, setNewItemAlarmEnabled] = useState(false);
            const [newItemAlarmTime, setNewItemAlarmTime] = useState('');
            const [newItemAlarmDate, setNewItemAlarmDate] = useState('');
            const [isRecurring, setIsRecurring] = useState(false);
            const [invQtySara, setInvQtySara] = useState('');
            const [invQtyNegocio, setInvQtyNegocio] = useState('');

            const [suggestions, setSuggestions] = useState([]);
            const [showSuggestions, setShowSuggestions] = useState(false);

            const fileInputRef = useRef(null);
            const longPressTimer = useRef(null);

            // --- Efectos ---
            useEffect(() => {
                if ('Notification' in window && Notification.permission !== 'granted') Notification.requestPermission();
                const interval = setInterval(() => checkAlarms(), 60000); 
                setTimeout(checkAlarms, 2000); 
                const savedItems = localStorage.getItem('barcaData_Ultimate_Finalv3');
                if (savedItems) try { setItems(JSON.parse(savedItems)); } catch (e) { }
                const now = new Date();
                setReportEndDate(formatDateInput(now));
                const lastMonth = new Date(now);
                lastMonth.setMonth(now.getMonth() - 1);
                setReportStartDate(formatDateInput(lastMonth));
                return () => clearInterval(interval);
            }, []);

            useEffect(() => {
                localStorage.setItem('barcaData_Ultimate_Finalv3', JSON.stringify(items));
            }, [items]);

            useEffect(() => {
                if (toastMessage) {
                    const timer = setTimeout(() => setToastMessage(null), 3000);
                    return () => clearTimeout(timer);
                }
            }, [toastMessage]);

            // --- Helpers ---
            const formatDateInput = (date) => {
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            };
            const getLocalISOString = () => {
                const date = new Date();
                const offset = date.getTimezoneOffset() * 60000;
                return new Date(date.getTime() - offset).toISOString().slice(0, -1);
            };
            const getTodayDateStr = () => new Date(new Date().getTime() - (new Date().getTimezoneOffset() * 60000)).toISOString().split('T')[0];
            const formatDate = (isoString) => {
                if(!isoString) return '';
                const date = new Date(isoString);
                return date.toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit', hour: '2-digit', minute:'2-digit' });
            };
            const formatDesiredDate = (dateStr) => {
                if(!dateStr) return '';
                const date = new Date(dateStr);
                const offset = date.getTimezoneOffset() * 60000;
                const adjusted = new Date(date.getTime() + offset);
                return adjusted.toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit' });
            };
            const vibrate = (ms = 50) => { if (navigator.vibrate) navigator.vibrate(ms); };

            // --- Notificaciones ---
            const checkAlarms = () => {
                const now = new Date();
                const todayStr = getTodayDateStr();
                const dayOfWeek = now.getDay();
                const timeStr = now.toTimeString().substring(0, 5);
                items.forEach(item => {
                    if (item.tabId === 2 && !item.completed && item.alarmEnabled && item.alarmTime) {
                        let shouldTrigger = false;
                        if (item.isRecurring && item.recurrence?.includes(dayOfWeek)) shouldTrigger = true;
                        else if (!item.isRecurring && item.alarmDate === todayStr) shouldTrigger = true;
                        if (shouldTrigger && item.alarmTime === timeStr) {
                            const key = `notified_${item.id}_${todayStr}_${timeStr}`;
                            if (!localStorage.getItem(key)) {
                                sendNotification(`¡Hora de hacer!`, item.text);
                                localStorage.setItem(key, 'true');
                            }
                        }
                    }
                });
            };

            const sendNotification = async (title, body) => {
                if (!('Notification' in window)) return;
                if (Notification.permission === 'granted') {
                    try {
                        const reg = await navigator.serviceWorker.ready;
                        if (reg && reg.showNotification) {
                             await reg.showNotification(title, { body: body, icon: 'https://upload.wikimedia.org/wikipedia/en/4/47/FC_Barcelona_%28crest%29.svg', vibrate: [200, 100, 200], tag: 'barca-alert' });
                        } else {
                            new Notification(title, { body, icon: 'https://upload.wikimedia.org/wikipedia/en/4/47/FC_Barcelona_%28crest%29.svg' });
                        }
                    } catch (e) { new Notification(title, { body }); }
                }
            };
            
            const triggerTestNotification = () => {
                if (Notification.permission !== 'granted') {
                    Notification.requestPermission().then(p => { if (p === 'granted') sendNotification("Barça Organizer", "Permisos concedidos."); });
                } else sendNotification("Barça Organizer", "¡Prueba de alarma exitosa!");
            };

            // --- Lógica General (No Duplicada) ---
            const onTouchStart = (e) => { setTouchEnd(null); setTouchStart(e.targetTouches[0].clientX); };
            const onTouchMove = (e) => { setTouchEnd(e.targetTouches[0].clientX); };
            const onTouchEnd = () => {
                if (!touchStart || !touchEnd) return;
                const distance = touchStart - touchEnd;
                const idx = TABS.findIndex(t => t.id === activeTab);
                if (distance > 50 && idx < TABS.length - 1) { setActiveTab(TABS[idx + 1].id); vibrate(30); }
                else if (distance < -50 && idx > 0) { setActiveTab(TABS[idx - 1].id); vibrate(30); }
            };

            const handleItemLongPressStart = (id) => { if (activeTab !== 3 || sortBy !== 'manual') return; longPressTimer.current = setTimeout(() => { setReorderModeId(id); vibrate([50, 50, 50]); }, 600); };
            const handleItemLongPressEnd = () => { if (longPressTimer.current) clearTimeout(longPressTimer.current); };
            const handleClickItem = (item) => {
                if (reorderModeId === item.id) { setReorderModeId(null); return; }
                if (item.tabId === 3) { setHistoryItem(item); openEditModal(item); } 
                else if (!showBodega) { openEditModal(item); }
            };

            const handleSortChange = (newSortBy) => { if (sortBy === newSortBy) setSortDir(sortDir === 'asc' ? 'desc' : 'asc'); else { setSortBy(newSortBy); setSortDir('asc'); } setShowSortMenu(false); };
            
            const handleTextChange = (text) => {
                setNewItemText(text);
                if ((activeTab === 0 || activeTab === 3)) {
                    const inventoryItems = items.filter(i => i.tabId === 3); 
                    if (text.trim().length === 0) { setSuggestions(inventoryItems.filter(i => !i.completed)); setShowSuggestions(true); } 
                    else { const matches = inventoryItems.filter(i => i.text.toLowerCase().includes(text.toLowerCase())); setSuggestions(matches); setShowSuggestions(matches.length > 0); }
                } else setShowSuggestions(false);
            };

            const selectSuggestion = (s) => {
                const txt = typeof s === 'string' ? s : s.text;
                const obj = typeof s === 'object' ? s : items.find(i => i.text === txt && i.tabId === 3);
                setNewItemText(txt); setShowSuggestions(false);
                if (activeTab === 0 && obj) {
                    const s = parseInt(obj.qtySara)||0; const n = parseInt(obj.qtyNegocio)||0;
                    if (s > 0 && n === 0) { setNewItemFrom('Sara'); setNewItemTo('Negocio'); } else if (n > 0 && s === 0) { setNewItemFrom('Negocio'); setNewItemTo('Sara'); }
                }
            };

            const initiateMoveFromInventory = (item) => { setActiveTab(0); resetForm(); setNewItemText(item.text); const s=parseInt(item.qtySara)||0; const n=parseInt(item.qtyNegocio)||0; if (n>0 && s===0) { setNewItemFrom('Negocio'); setNewItemTo('Sara'); } else { setNewItemFrom('Sara'); setNewItemTo('Negocio'); } setIsModalOpen(true); };
            const existsInInventory = items.some(i => i.tabId === 3 && i.text.toLowerCase().trim() === newItemText.toLowerCase().trim());
            const swapLocations = () => setNewItemFrom(prev => { const old = newItemTo; setNewItemTo(prev); return old; });
            const toggleDay = (dayId) => { if (newItemRecurrence.includes(dayId)) setNewItemRecurrence(newItemRecurrence.filter(d => d !== dayId)); else setNewItemRecurrence([...newItemRecurrence, dayId].sort()); };
            const isRecurringCompletedToday = (item) => item.isRecurring && item.lastCompletedDate === getTodayDateStr();

            // Lógica visible items
            const getVisibleItems = () => {
                const todayStr = getTodayDateStr();
                const todayIndex = new Date().getDay();
                let filtered = items.filter(item => {
                    if (showBodega) return item.tabId === activeTab && item.completed && !item.isRecurring;
                    if (activeTab === 2 && item.isRecurring) { if (!item.recurrence?.includes(todayIndex)) return false; return true; }
                    if (activeTab === 1 || activeTab === 2) return item.tabId === activeTab;
                    return item.tabId === activeTab && !item.completed;
                });
                if (sortBy === 'priority') filtered.sort((a, b) => { const vA = PRIORITIES[a.priority]?.value||0; const vB = PRIORITIES[b.priority]?.value||0; return sortDir==='asc' ? vB-vA : vA-vB; });
                else if (sortBy === 'zone') filtered.sort((a, b) => { const vA = a.context||''; const vB = b.context||''; return sortDir==='asc' ? vA.localeCompare(vB) : vB.localeCompare(vA); });
                else if (sortBy === 'date') filtered.sort((a, b) => { const dA = a.desiredDate||a.createdAt; const dB = b.desiredDate||b.createdAt; return sortDir==='asc' ? new Date(dA)-new Date(dB) : new Date(dB)-new Date(dA); });
                if ((activeTab===1 || activeTab===2) && !showBodega && sortBy==='manual') filtered.sort((a, b) => { const aDone = a.isRecurring ? a.lastCompletedDate === todayStr : a.completed; const bDone = b.isRecurring ? b.lastCompletedDate === todayStr : b.completed; return (aDone === bDone ? 0 : aDone ? 1 : -1); });
                return filtered;
            };
            const visibleItems = getVisibleItems();

            const currentInventoryItem = activeTab === 0 ? items.find(i => i.tabId === 3 && i.text.toLowerCase().trim() === newItemText.toLowerCase().trim()) : null;
            const availableStock = currentInventoryItem ? (newItemFrom === 'Sara' ? (parseInt(currentInventoryItem.qtySara)||0) : (parseInt(currentInventoryItem.qtyNegocio)||0)) : null;
            const isMoveQuantityValid = currentInventoryItem ? (newItemQuantity && parseInt(newItemQuantity) <= availableStock && parseInt(newItemQuantity) > 0) : true;
            const canSwap = currentInventoryItem ? (newItemFrom === 'Sara' ? (parseInt(currentInventoryItem.qtyNegocio)||0) > 0 : (parseInt(currentInventoryItem.qtySara)||0) > 0) : true;
            const stockSara = consumeItem ? (parseInt(consumeItem.qtySara)||0) : 0;
            const stockNegocio = consumeItem ? (parseInt(consumeItem.qtyNegocio)||0) : 0;
            const qtyNum = parseInt(consumeQty)||0;
            const isValidConsume = qtyNum > 0 && ((consumeLocation === 'Sara' && qtyNum <= stockSara) || (consumeLocation === 'Negocio' && qtyNum <= stockNegocio));

            // Handlers
            const openEditModal = (item) => {
                setEditingItem(item); setNewItemText(item.text); setNewItemPriority(item.priority||'none');
                if (item.tabId===3) {
                    setInvQtySara(item.qtySara); setInvQtyNegocio(item.qtyNegocio);
                } else if (item.tabId===0) {
                    setNewItemQuantity(item.quantity||''); setNewItemFrom(item.from||'Sara'); setNewItemTo(item.to||'Negocio');
                } else {
                    setNewItemQuantity(item.quantity||''); setNewItemContext(item.context||'-'); setNewItemPrice(item.price||''); setNewItemDate(item.desiredDate||'');
                    setNewItemAlarmEnabled(item.alarmEnabled||false); setNewItemAlarmTime(item.alarmTime||''); 
                    setIsRecurring(item.isRecurring); setNewItemRecurrence(item.recurrence||[]); setNewItemAlarmDate(item.alarmDate||getTodayDateStr());
                }
                setActiveTab(item.tabId); setIsModalOpen(true);
            };
            const closeModal = () => { setIsModalOpen(false); setEditingItem(null); resetForm(); };
            const resetForm = () => {
                setNewItemText(''); setSuggestions([]); setShowSuggestions(false); setNewItemQuantity(''); setNewItemPriority('none');
                setNewItemFrom('Sara'); setNewItemTo('Negocio'); setAddToInventory(false);
                setInvQtySara(''); setInvQtyNegocio(''); setNewItemPrice(''); setNewItemDate('');
                setNewItemRecurrence([]); setNewItemContext('-');
                setNewItemAlarmEnabled(false); setNewItemAlarmTime(''); setIsRecurring(false); setNewItemAlarmDate(getTodayDateStr());
            };
            const handleKeyDown = (e) => { if (e.key === 'Enter') { e.preventDefault(); saveItem(); } };

            const saveItem = () => {
                if (!newItemText.trim()) return;
                if (activeTab === 3 && !editingItem) {
                    const s = parseInt(invQtySara)||0; const n = parseInt(invQtyNegocio)||0;
                    if (s+n <= 0) { alert("Agregar al menos 1 unidad."); return; }
                }
                if (activeTab === 0 && currentInventoryItem) {
                    if (currentInventoryItem.completed) { alert("Producto AGOTADO en archivo."); return; }
                    if (!isMoveQuantityValid) { alert(`Solo cuentas con ${availableStock} unidades.`); return; }
                }
                let newItemsList = [...items];
                const ts = getLocalISOString();
                if (activeTab === 3 && !editingItem && existsInInventory) {
                    const idx = newItemsList.findIndex(i => i.tabId===3 && i.text.toLowerCase().trim()===newItemText.toLowerCase().trim());
                    if (idx !== -1) {
                        const p = { ...newItemsList[idx] };
                        const addS = parseInt(invQtySara)||0; const addN = parseInt(invQtyNegocio)||0;
                        if (addS+addN <= 0) { alert("Agregar al menos 1 unidad."); return; }
                        p.qtySara = (parseInt(p.qtySara)||0)+addS; p.qtyNegocio = (parseInt(p.qtyNegocio)||0)+addN;
                        if (p.completed) p.completed = false;
                        p.hasSara = p.qtySara>0; p.hasNegocio = p.qtyNegocio>0;
                        const h = { date: ts, addedSara: addS, addedNegocio: addN, type: 'add' };
                        p.history = p.history ? [h, ...p.history] : [h];
                        p.updatedAt = ts;
                        newItemsList[idx] = p;
                        setItems(newItemsList); closeModal(); vibrate(30); return;
                    }
                }
                const itemData = { text: newItemText, priority: newItemPriority, updatedAt: ts };
                if (activeTab === 0) {
                    itemData.from = newItemFrom; itemData.to = newItemTo; itemData.quantity = newItemQuantity;
                    itemData.completed = editingItem ? editingItem.completed : false;
                } else if (activeTab === 3) {
                    itemData.qtySara = parseInt(invQtySara)||0; itemData.qtyNegocio = parseInt(invQtyNegocio)||0;
                    itemData.hasSara = itemData.qtySara > 0; itemData.hasNegocio = itemData.qtyNegocio > 0;
                    if (editingItem && (itemData.qtySara > 0 || itemData.qtyNegocio > 0)) itemData.completed = false;
                    else itemData.completed = editingItem ? editingItem.completed : false;
                    if (!editingItem) { itemData.history = [{ date: ts, addedSara: itemData.qtySara, addedNegocio: itemData.qtyNegocio, type: 'create' }]; itemData.createdAt = ts; }
                    else { itemData.history = editingItem.history; itemData.createdAt = editingItem.createdAt; }
                } else {
                    itemData.context = newItemContext || '-'; itemData.quantity = newItemQuantity;
                    if (activeTab === 1) { itemData.price = newItemPrice; itemData.desiredDate = newItemDate; }
                    if (activeTab === 2) {
                        itemData.alarmEnabled = newItemAlarmEnabled; itemData.alarmTime = newItemAlarmTime; itemData.isRecurring = isRecurring; 
                        if (isRecurring) { itemData.recurrence = newItemRecurrence; itemData.alarmDate = null; } else { itemData.alarmDate = newItemAlarmDate; itemData.recurrence = []; }
                    }
                    itemData.completed = editingItem ? editingItem.completed : false;
                }
                if (editingItem) { newItemsList = newItemsList.map(i => i.id === editingItem.id ? { ...i, ...itemData } : i); } 
                else {
                    const newItem = { ...itemData, id: Date.now(), tabId: activeTab, createdAt: ts };
                    newItemsList = [newItem, ...newItemsList];
                    if (activeTab === 0 && addToInventory && !existsInInventory) {
                         const q = parseInt(newItemQuantity)||0; let s = 0; let n = 0;
                         if (newItemTo === 'Negocio') n = q; if (newItemTo === 'Sara') s = q;
                         const inv = { id: Date.now()+1, tabId: 3, text: newItemText, qtySara: s, qtyNegocio: n, hasSara: s>0, hasNegocio: n>0, priority: 'none', completed: false, createdAt: ts, updatedAt: ts, history: [{date: ts, addedSara: s, addedNegocio: n, type: 'auto-create'}] };
                         newItemsList = [inv, ...newItemsList];
                    }
                }
                setItems(newItemsList); closeModal(); vibrate(30);
            };

            const toggleStatus = (id) => {
                vibrate(20);
                const todayStr = getTodayDateStr();
                let updatedItems = [...items];
                const target = updatedItems.find(i => i.id === id);
                if (!target) return;
                if (target.tabId === 0 && !target.completed && !showBodega) {
                    updatedItems = processLogisticsMove(target);
                    const processed = updatedItems.find(i => i.id === id);
                    processed.completed = true;
                } else if (target.isRecurring) {
                     target.lastCompletedDate = (target.lastCompletedDate === todayStr) ? null : todayStr;
                } else {
                    target.completed = !target.completed;
                }
                setItems([...updatedItems]);
            };

            const requestDelete = (id, e) => {
                if (e) { e.stopPropagation(); e.preventDefault(); }
                setTimeout(() => { setItemToDelete(id); }, 10);
            };

            const confirmDelete = () => {
                 setItems(prev => prev.filter(i => i.id !== itemToDelete));
                 setItemToDelete(null); if(isModalOpen) closeModal(); setToastMessage("Eliminado correctamente");
            };

            const moveItem = (id, direction) => {
                const list = visibleItems;
                const idxVis = list.findIndex(i => i.id === id);
                if (idxVis === -1) return;
                const swapIdx = idxVis + direction;
                if (swapIdx < 0 || swapIdx >= list.length) return;
                const itemA = list[idxVis]; const itemB = list[swapIdx];
                const realA = items.findIndex(i => i.id === itemA.id);
                const realB = items.findIndex(i => i.id === itemB.id);
                const newItems = [...items];
                const temp = newItems[realA]; newItems[realA] = newItems[realB]; newItems[realB] = temp;
                setItems(newItems); vibrate(20);
            };

            const openConsumeModal = (item) => {
                setConsumeItem(item); setConsumeQty('');
                const s = parseInt(item.qtySara)||0; const n = parseInt(item.qtyNegocio)||0;
                if (s>0) setConsumeLocation('Sara'); else if (n>0) setConsumeLocation('Negocio'); else setConsumeLocation('');
                setIsConsumeModalOpen(true);
            };

            const handleConsume = () => {
                if (!consumeItem || !consumeQty) return;
                const qty = parseInt(consumeQty);
                if (isNaN(qty) || qty <= 0) return;
                const newItems = [...items];
                const idx = newItems.findIndex(i => i.id === consumeItem.id);
                if (idx === -1) return;
                const p = { ...newItems[idx] };
                let current = consumeLocation === 'Sara' ? (parseInt(p.qtySara)||0) : (parseInt(p.qtyNegocio)||0);
                if (qty > current) { alert(`No hay suficiente stock en ${consumeLocation}.`); return; }
                if (consumeLocation === 'Sara') p.qtySara = (parseInt(p.qtySara)||0) - qty;
                else p.qtyNegocio = (parseInt(p.qtyNegocio)||0) - qty;
                p.hasSara = (p.qtySara > 0); p.hasNegocio = (p.qtyNegocio > 0);
                const total = (parseInt(p.qtySara)||0) + (parseInt(p.qtyNegocio)||0);
                let extra = null;
                if (total === 0) { extra = { date: getLocalISOString(), type: 'exhausted', detail: '⚠️ STOCK AGOTADO' }; p.completed = true; vibrate(100); }
                const hist = { date: getLocalISOString(), type: 'consume', qty: qty, location: consumeLocation };
                p.history = p.history ? [hist, ...p.history] : [hist];
                if (extra) p.history = [extra, ...p.history];
                p.updatedAt = getLocalISOString();
                newItems[idx] = p;
                setItems(newItems); setIsConsumeModalOpen(false); setConsumeItem(null);
            };

            const exportData = () => { const s = JSON.stringify(items); const b = new Blob([s],{type:'application/json'}); const l = document.createElement('a'); l.href=URL.createObjectURL(b); l.download='backup.json'; l.click(); };
            const importData = (e) => { const f=e.target.files[0]; if(!f)return; const r=new FileReader(); r.onload=(ev)=>{ try{setItems(JSON.parse(ev.target.result))}catch(x){}}; r.readAsText(f); e.target.value=null; };
            const generatePDFReport = () => {
                const all=[]; const ss=reportStartDate; const es=reportEndDate;
                items.forEach(i=>{
                    if(i.tabId===3 && i.history) {
                        i.history.forEach(h=>{
                            const hDate = h.date.substring(0,10);
                            if(hDate >= ss && hDate <= es) all.push({...h, productName: i.text});
                        });
                    }
                });
                all.sort((a,b)=>new Date(a.date)-new Date(b.date));
                const w=window.open('','_blank'); if(!w){alert('Popups blocked');return;}
                w.document.write(`<html><head><title>Reporte</title><style>body{font-family:Arial;padding:20px}table{width:100%;border-collapse:collapse}th,td{border:1px solid #ccc;padding:8px}</style></head><body><h1>Reporte</h1><table><thead><tr><th>Fecha</th><th>Producto</th><th>Tipo</th><th>Detalle</th></tr></thead><tbody>${all.map(m=>`<tr><td>${new Date(m.date).toLocaleString()}</td><td>${m.productName}</td><td>${m.type}</td><td>${m.type==='consume'?`-${m.qty} (${m.location})`:m.detail||`+${m.addedSara||0}S +${m.addedNegocio||0}N`}</td></tr>`).join('')}</tbody></table></body></html>`); w.document.close();
            };

            const TABS = [
                { id: 3, title: 'Inventario', icon: React.createElement(Package, { size: 18 }), color: 'yellow' },
                { id: 0, title: 'Movilizar', icon: React.createElement(Truck, { size: 18 }), color: 'blue' },
                { id: 2, title: 'Hacer', icon: React.createElement(CheckSquare, { size: 18 }), color: 'blue-red' },
                { id: 1, title: 'Comprar', icon: React.createElement(ShoppingCart, { size: 18 }), color: 'red' }
            ];
            const DAYS_OF_WEEK = [{id:0,l:'D'},{id:1,l:'L'},{id:2,l:'M'},{id:3,l:'M'},{id:4,l:'J'},{id:5,l:'V'},{id:6,l:'S'}];
            const PRIORITIES = { none: { value: 0, color: 'bg-gray-700', label: '---' }, baja: { value: 1, color: 'bg-red-600', label: 'Baja' }, media: { value: 2, color: 'bg-yellow-500', label: 'Media' }, alta: { value: 3, color: 'bg-green-600', label: 'Alta' } };

            return React.createElement("div", { className: "flex flex-col h-dvh bg-[#121212] font-sans max-w-full mx-auto shadow-2xl overflow-hidden relative border-x-0 sm:border-x-4 border-[#004D98] text-gray-100", 
                onTouchStart: onTouchStart, onTouchMove: onTouchMove, onTouchEnd: onTouchEnd 
            },
                React.createElement("header", { className: "bg-gradient-to-r from-[#004D98] via-[#081f38] to-[#A50044] text-white pt-4 pb-0 shadow-lg z-10 sticky top-0" },
                    React.createElement("div", { className: "flex justify-between items-center px-4 mb-2" },
                        React.createElement("h1", { className: "text-xl font-bold text-[#EDBB00] tracking-tight italic drop-shadow-md" }, showBodega ? 'Archivo' : 'Força Stock'),
                        React.createElement("div", { className: "flex gap-2" },
                            React.createElement("button", { onClick: () => setShowSortMenu(!showSortMenu), className: `p-3 rounded-full transition ${showSortMenu ? 'bg-[#EDBB00] text-[#004D98]' : 'bg-white/10 text-white'}`, title: "Ordenar" }, React.createElement(ListFilter, { size: 20 })),
                            React.createElement("button", { onClick: () => setShowBodega(!showBodega), className: `p-3 rounded-full transition ${showBodega ? 'bg-[#EDBB00] text-[#004D98]' : 'bg-white/10 text-white'}`, title: "Bodega" }, React.createElement(Archive, { size: 20 })),
                            React.createElement("button", { onClick: () => setShowSettings(!showSettings), className: `p-3 rounded-full transition ${showSettings ? 'bg-[#EDBB00] text-[#004D98]' : 'bg-white/10 text-white'}`, title: "Config" }, React.createElement(Settings, { size: 20 }))
                        )
                    ),
                    showSortMenu && React.createElement("div", { className: "px-4 pb-3 flex gap-2 overflow-x-auto no-scrollbar" },
                         ['manual', 'priority', 'zone', 'date'].map(s => React.createElement("button", { key: s, onClick: () => handleSortChange(s), className: `px-4 py-2 rounded-full text-xs font-bold border flex items-center gap-1 ${sortBy===s?'bg-[#EDBB00] text-[#004D98] border-[#EDBB00]':'bg-white/10 text-gray-300 border-white/20'}` }, s.toUpperCase(), sortBy===s && (sortDir==='asc'?'⬆️':'⬇️')))
                    ),
                    showSettings && React.createElement("div", { className: "absolute top-16 right-4 bg-[#1e1e1e] border border-gray-700 rounded-xl shadow-2xl p-4 z-50 w-64" },
                        React.createElement("div", { className: "flex flex-col gap-3" },
                            React.createElement("button", { onClick: triggerTestNotification, className: "flex items-center gap-3 p-3 text-sm hover:bg-gray-800 rounded-lg text-[#EDBB00] font-bold" }, React.createElement(BellRing, { size: 18 }), "Probar Notificación"),
                            React.createElement("button", { onClick: () => { setIsReportModalOpen(true); setShowSettings(false); }, className: "flex items-center gap-3 p-3 text-sm hover:bg-gray-800 rounded-lg text-[#EDBB00] font-bold" }, React.createElement(FileText, { size: 18 }), "Reporte PDF"),
                            React.createElement("div", { className: "h-px bg-gray-700 my-1" }),
                            React.createElement("button", { onClick: () => fileInputRef.current.click(), className: "flex items-center gap-3 p-3 text-sm hover:bg-gray-800 rounded-lg text-gray-300" }, React.createElement(Upload, { size: 18 }), "Importar"),
                            React.createElement("button", { onClick: exportData, className: "flex items-center gap-3 p-3 text-sm hover:bg-gray-800 rounded-lg text-gray-300" }, React.createElement(Download, { size: 18 }), "Exportar")
                        )
                    ),
                    React.createElement("div", { className: "flex justify-between items-end mt-2 overflow-x-auto no-scrollbar" },
                        TABS.map((tab, index) => React.createElement("button", { key: tab.id, onClick: () => { setActiveTab(tab.id); setShowBodega(false); vibrate(20); }, className: `flex-1 min-w-[80px] flex flex-col items-center pb-3 px-1 transition-all ${activeTab === tab.id ? 'text-[#EDBB00] border-b-4 border-[#EDBB00] bg-white/5' : 'text-gray-400 border-b-4 border-transparent'}` }, React.createElement("div", { className: "mb-1" }, tab.icon), React.createElement("span", { className: "text-[10px] uppercase font-bold" }, tab.title)))
                    )
                ),
                React.createElement("main", { className: "flex-1 overflow-y-auto bg-[#0a0a0a] p-3 pb-32" },
                    showBodega && React.createElement("div", { className: "bg-[#EDBB00]/10 border-l-4 border-[#EDBB00] text-[#EDBB00] p-3 text-sm mb-4 flex items-center gap-3 rounded-r font-medium" }, React.createElement(AlertCircle, { size: 18 }), React.createElement("span", null, activeTab === 3 ? "Inventario Agotado" : "Items completados")),
                    React.createElement("div", { className: "space-y-3" },
                        visibleItems.length === 0 && React.createElement("div", { className: "flex flex-col items-center justify-center py-20 text-gray-600 opacity-50" }, React.createElement("div", { className: "mb-2 scale-150" }, TABS.find(t=>t.id===activeTab)?.icon), React.createElement("p", { className: "text-sm" }, "Lista vacía")),
                        visibleItems.map((item, idx) => {
                            const isRecurCompleted = isRecurringCompletedToday(item);
                            const isItemCompleted = item.isRecurring ? isRecurCompleted : item.completed;
                            return React.createElement("div", { key: item.id, className: `flex items-stretch bg-[#1e1e1e] rounded-xl shadow-md border overflow-hidden min-h-[60px] relative ${isItemCompleted && (activeTab===1||activeTab===2) ? 'opacity-50 border-gray-800' : 'border-gray-800'}`, onClick: () => handleClickItem(item) },
                                React.createElement("div", { className: `w-2 ${PRIORITIES[item.priority]?.color || 'bg-gray-800'}` }),
                                item.tabId !== 3 && React.createElement("button", { onClick: (e) => { e.stopPropagation(); toggleStatus(item.id); }, className: "w-12 flex items-center justify-center bg-[#252525] border-r border-gray-800 active:bg-black" }, isItemCompleted ? React.createElement(CheckSquare, { size: 20, className: "text-[#004D98]" }) : React.createElement("div", { className: "w-6 h-6 rounded-md border-2 border-gray-500 hover:border-[#A50044]" })),
                                React.createElement("div", { className: "flex-1 py-3 px-4 flex flex-col justify-center min-w-0" },
                                    item.tabId === 2 && item.recurrence && item.recurrence.length > 0 && React.createElement("div", { className: "flex gap-1 mb-1" }, DAYS_OF_WEEK.map(d => React.createElement("span", { key: d.id, className: `text-[9px] font-bold ${item.recurrence.includes(d.id) ? 'text-[#EDBB00]' : 'text-gray-700'}` }, d.label))),
                                    React.createElement("div", { className: "flex justify-between items-start mb-2" },
                                        React.createElement("span", { className: `text-base font-semibold leading-tight line-clamp-2 mr-2 ${isItemCompleted && (activeTab===1||activeTab===2) ? 'line-through text-gray-500' : 'text-gray-100'}` }, item.text, showBodega && item.tabId === 3 && React.createElement("span", { className: "ml-2 text-[10px] bg-red-900/50 text-red-300 px-1 rounded uppercase font-bold" }, "AGOTADO"), item.isRecurring && React.createElement("span", { className: "ml-2 inline-flex items-center text-[#EDBB00]" }, React.createElement(Repeat, {size:12}))),
                                        item.tabId === 2 && item.alarmEnabled && React.createElement("span", { className: "text-xs text-[#EDBB00] flex items-center gap-1 bg-[#EDBB00]/10 px-2 py-0.5 rounded" }, React.createElement(Bell, {size:12}), item.alarmTime),
                                        item.tabId === 3 && !showBodega && React.createElement("button", { onClick: (e) => { e.stopPropagation(); openConsumeModal(item); vibrate(20); }, className: "p-2 bg-red-900/20 text-red-500 border border-red-900/40 rounded-lg active:bg-red-900/40 transition shrink-0" }, React.createElement(TrendingDown, { size: 18 }))
                                    ),
                                    React.createElement("div", { className: "flex flex-wrap items-center gap-2 select-none" },
                                        item.tabId === 3 && React.createElement(React.Fragment, null,
                                            !showBodega ? React.createElement(React.Fragment, null, (item.hasSara || item.qtySara > 0) && React.createElement("div", { className: "flex items-center gap-1 px-2 py-0.5 bg-purple-900/40 text-purple-300 rounded border border-purple-800" }, React.createElement("span", { className: "text-[10px] font-bold" }, "S:"), React.createElement("span", { className: "text-xs font-bold" }, item.qtySara)), (item.hasNegocio || item.qtyNegocio > 0) && React.createElement("div", { className: "flex items-center gap-1 px-2 py-0.5 bg-blue-900/40 text-blue-300 rounded border border-blue-800" }, React.createElement(Store, { size: 10 }), React.createElement("span", { className: "text-xs font-bold" }, item.qtyNegocio)), React.createElement("div", { className: "flex items-center gap-1 px-2 py-0.5 bg-gray-800 text-gray-200 rounded border border-gray-600" }, React.createElement("span", { className: "text-[10px] font-bold" }, "T:"), React.createElement("span", { className: "text-xs font-bold text-[#EDBB00]" }, (parseInt(item.qtySara)||0) + (parseInt(item.qtyNegocio)||0)))) : React.createElement("div", { className: "text-xs text-gray-500 italic" }, "Toca para reabastecer")
                                        ),
                                        (item.tabId === 1) && item.context && item.context !== '-' && React.createElement("div", { className: "flex items-center gap-1 px-2 py-0.5 bg-gray-800 rounded border border-gray-700 text-xs text-gray-400" }, item.context === 'Casa' ? React.createElement(Home, { size: 10 }) : item.context === 'Negocio' ? React.createElement(Store, { size: 10 }) : React.createElement(User, { size: 10 }), item.context),
                                        (item.tabId === 1) && item.price && React.createElement("span", { className: "text-xs text-green-400 font-mono" }, "$", item.price),
                                        (item.tabId === 1 || item.tabId === 2) && item.desiredDate && React.createElement("span", { className: "text-xs text-blue-300 flex items-center gap-1" }, React.createElement(Calendar, { size: 10 }), formatDesiredDate(item.desiredDate)),
                                        item.tabId !== 3 && item.quantity && React.createElement("span", { className: "px-2 py-0.5 bg-[#EDBB00]/20 text-[#EDBB00] text-[10px] font-bold rounded uppercase border border-[#EDBB00]/30" }, item.quantity),
                                        item.tabId === 0 && React.createElement("div", { className: "flex items-center gap-1 text-[10px] bg-black/30 px-2 py-1 rounded border border-gray-800 text-gray-400 font-medium" }, item.from, React.createElement(ArrowRight, { size: 10, className: "text-[#EDBB00]" }), item.to),
                                        React.createElement("span", { className: "text-[9px] text-gray-600 flex items-center gap-1 ml-auto" }, React.createElement(Calendar, { size: 10 }), formatDate(item.createdAt || item.updatedAt))
                                    )
                                ),
                                React.createElement("div", { className: "flex flex-col items-center justify-center py-2 px-1 border-l border-gray-800 bg-[#252525] w-12 gap-4" },
                                    item.tabId === 3 && !showBodega && React.createElement("button", { onClick: (e) => { e.stopPropagation(); initiateMoveFromInventory(item); vibrate(20); }, className: "p-2 text-blue-400 active:text-white transition rounded-full" }, React.createElement(Truck, { size: 18 })),
                                    React.createElement("button", { onClick: (e) => requestDelete(item.id, e), className: "p-2 text-gray-500 hover:text-red-500 transition rounded-full" }, React.createElement(Trash2, { size: 18 }))
                                )
                            )
                        })
                    )
                ),
                !showBodega && React.createElement("button", { onClick: () => { resetForm(); setIsModalOpen(true); vibrate(30); }, className: "fixed bottom-8 right-6 w-16 h-16 bg-[#EDBB00] rounded-full shadow-[0_4px_20px_rgba(237,187,0,0.4)] flex items-center justify-center text-[#004D98] active:scale-90 transition-transform z-40 border-2 border-[#004D98]" }, React.createElement(Plus, { size: 36, strokeWidth: 3 })),
                toastMessage && React.createElement("div", { className: "fixed bottom-28 left-1/2 -translate-x-1/2 bg-[#1e1e1e] text-white px-6 py-3 rounded-full text-sm font-bold shadow-2xl border border-[#004D98] z-50 flex items-center gap-3 toast-animate" }, React.createElement(Check, { size: 20, className: "text-green-400" }), toastMessage),
                itemToDelete && React.createElement("div", { className: "fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4 animate-in fade-in" },
                    React.createElement("div", { className: "bg-[#1e1e1e] w-full max-w-xs rounded-2xl p-6 border border-gray-700 text-center" },
                        React.createElement("div", { className: "w-12 h-12 bg-red-900/30 rounded-full flex items-center justify-center mx-auto mb-4" }, React.createElement(Trash2, { className: "text-red-500", size: 24 })),
                        React.createElement("h3", { className: "text-lg font-bold text-white mb-2" }, "¿Borrar definitivamente?"),
                        React.createElement("div", { className: "flex gap-3" },
                            React.createElement("button", { onClick: () => setItemToDelete(null), className: "flex-1 py-3 bg-gray-700 rounded-xl text-white font-bold" }, "Cancelar"),
                            React.createElement("button", { onClick: confirmDelete, className: "flex-1 py-3 bg-red-600 rounded-xl text-white font-bold active:bg-red-700" }, "Borrar")
                        )
                    )
                ),
                isModalOpen && React.createElement("div", { className: "fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-end sm:items-center justify-center p-4" },
                    React.createElement("div", { className: "bg-[#1e1e1e] w-full max-w-sm rounded-t-2xl sm:rounded-2xl shadow-2xl p-6 flex flex-col max-h-[85dvh] overflow-y-auto border border-gray-800" },
                        React.createElement("div", { className: "flex justify-between items-center mb-6 border-b border-gray-700 pb-4" }, React.createElement("h2", { className: "text-xl font-bold text-[#EDBB00] flex items-center gap-2" }, editingItem ? React.createElement(Pencil, { size: 20 }) : React.createElement(Plus, { size: 20 }), editingItem ? (editingItem.completed && editingItem.tabId === 3 ? 'Reabastecer' : 'Editar') : 'Nuevo', ": ", TABS.find(t => t.id === activeTab)?.title), React.createElement("button", { onClick: closeModal, className: "text-gray-500 hover:text-white p-2" }, React.createElement(X, { size: 24 }))),
                        React.createElement("div", { className: "space-y-5 relative" },
                            React.createElement("div", { className: "relative" }, React.createElement("label", { className: "text-xs font-bold text-gray-500 uppercase mb-1 block" }, "Nombre"), React.createElement("input", { type: "text", className: "w-full p-4 bg-[#121212] border border-gray-700 rounded-xl outline-none text-base text-white focus:border-[#EDBB00] transition", value: newItemText, onChange: (e) => handleTextChange(e.target.value), onKeyDown: handleKeyDown, autoFocus: true }), showSuggestions && (activeTab === 0 || activeTab === 3) && React.createElement("div", { className: "absolute top-full left-0 right-0 bg-[#252525] border border-gray-700 rounded-xl shadow-xl mt-1 z-50 max-h-48 overflow-y-auto" }, suggestions.map(s => React.createElement("button", { key: s.id, onClick: () => selectSuggestion(s), className: "w-full text-left px-4 py-3 text-sm text-gray-300 hover:bg-[#EDBB00] hover:text-[#004D98] block border-b border-gray-800 last:border-0" }, s.text)))),
                            activeTab === 3 ? React.createElement("div", { className: "bg-[#252525] p-4 rounded-xl border border-gray-700" },
                                React.createElement("div", { className: "flex justify-between items-center mb-3" }, React.createElement("label", { className: "text-xs font-bold text-[#EDBB00] uppercase" }, "Stock Actual"), editingItem && editingItem.completed && React.createElement("span", { className: "text-xs text-green-400 font-bold" }, "REACTIVAR")),
                                React.createElement("div", { className: "space-y-3" },
                                    React.createElement("div", { className: "flex items-center gap-3" }, React.createElement("div", { className: "w-12 h-12 flex-none flex items-center justify-center bg-[#1e1e1e] border border-purple-900 rounded-lg text-purple-400" }, React.createElement(User, { size: 24 })), React.createElement("input", { type: "number", placeholder: "0", value: invQtySara, onChange: e=>setInvQtySara(e.target.value), className: "flex-1 min-w-0 p-3 bg-[#121212] border border-purple-900 rounded-lg text-center text-white font-bold text-lg" })),
                                    React.createElement("div", { className: "flex items-center gap-3" }, React.createElement("div", { className: "w-12 h-12 flex-none flex items-center justify-center bg-[#1e1e1e] border border-blue-900 rounded-lg text-blue-400" }, React.createElement(Store, { size: 24 })), React.createElement("input", { type: "number", placeholder: "0", value: invQtyNegocio, onChange: e=>setInvQtyNegocio(e.target.value), className: "flex-1 min-w-0 p-3 bg-[#121212] border border-blue-900 rounded-lg text-center text-white font-bold text-lg" }))
                                )
                            ) : activeTab !== 2 ? React.createElement("div", { className: "relative" }, React.createElement("label", { className: "text-xs font-bold text-gray-500 uppercase mb-1 block" }, "Cantidad"), React.createElement("input", { type: "number", className: `w-full p-4 bg-[#121212] border rounded-xl outline-none text-base text-white transition ${!isMoveQuantityValid && activeTab === 0 ? 'border-red-500' : 'border-gray-700 focus:border-[#EDBB00]'}`, value: newItemQuantity, onChange: (e) => setNewItemQuantity(e.target.value), onKeyDown: handleKeyDown }), activeTab === 0 && currentInventoryItem && React.createElement("div", { className: "mt-2 flex justify-between text-xs" }, React.createElement("span", { className: "text-gray-400" }, `Disponible en ${newItemFrom}:`), React.createElement("span", { className: `${!isMoveQuantityValid ? 'text-red-500 font-bold' : 'text-green-400 font-bold'}` }, availableStock))) : null,
                            (activeTab === 1) && React.createElement("div", { className: "flex gap-3" },
                                React.createElement("div", { className: "relative flex-1" }, React.createElement("label", { className: "text-xs font-bold text-gray-500 uppercase mb-1 block" }, "Precio"), React.createElement("input", { type: "number", className: "w-full p-3 pl-8 bg-[#121212] border border-gray-700 rounded-lg text-white text-sm", value: newItemPrice, onChange: e=>setNewItemPrice(e.target.value), onKeyDown: handleKeyDown }), React.createElement(DollarSign, { size: 14, className: "absolute left-3 top-9 text-gray-500" })),
                                React.createElement("div", { className: "relative flex-1" }, React.createElement("label", { className: "text-xs font-bold text-gray-500 uppercase mb-1 block" }, "Fecha"), React.createElement("input", { type: "date", className: "w-full p-3 pl-8 bg-[#121212] border border-gray-700 rounded-lg text-white text-sm", value: newItemDate, onChange: e=>setNewItemDate(e.target.value), onKeyDown: handleKeyDown }), React.createElement(Calendar, { size: 14, className: "absolute left-3 top-9 text-gray-500" }))
                            ),
                            (activeTab === 1) && React.createElement("div", { className: "flex gap-2" }, ['-', 'Negocio', 'Casa', 'Personal'].map(ctx => React.createElement("button", { key: ctx, onClick: () => setNewItemContext(ctx), className: `flex-1 py-2 rounded-lg border text-xs flex items-center justify-center gap-1 transition ${newItemContext === ctx ? 'bg-gray-700 border-gray-500 text-white font-bold' : 'bg-[#121212] border-gray-700 text-gray-500'}` }, ctx === '-' ? React.createElement(CircleSlash, {size:12}) : ctx === 'Negocio' ? React.createElement(Store, {size:12}) : ctx === 'Casa' ? React.createElement(Home, {size:12}) : React.createElement(User, {size:12}), ctx === '-' ? 'Sin Cat.' : ctx))),
                            activeTab === 2 && React.createElement(React.Fragment, null,
                                React.createElement("div", { className: "bg-[#252525] p-4 rounded-xl border border-gray-700 mb-2" },
                                    React.createElement("div", { className: "flex justify-between items-center mb-4" }, React.createElement("label", { className: "text-xs font-bold text-[#EDBB00] uppercase flex items-center gap-2" }, React.createElement(Bell, {size:14}), " Alarma"), React.createElement("div", { onClick: () => setNewItemAlarmEnabled(!newItemAlarmEnabled), className: `w-10 h-6 rounded-full p-1 cursor-pointer transition-colors ${newItemAlarmEnabled ? 'bg-[#004D98]' : 'bg-gray-600'}` }, React.createElement("div", { className: `bg-white w-4 h-4 rounded-full shadow-md transform transition-transform ${newItemAlarmEnabled ? 'translate-x-4' : ''}` }))),
                                    newItemAlarmEnabled && React.createElement("div", { className: "animate-in fade-in slide-in-from-top-2 space-y-3" },
                                        React.createElement("input", { type: "time", className: "w-full p-3 bg-[#121212] border border-gray-600 rounded-lg text-white text-center font-bold text-lg", value: newItemAlarmTime, onChange: e=>setNewItemAlarmTime(e.target.value) }),
                                        React.createElement("div", { className: "flex gap-2 items-center text-xs text-gray-400 mb-1" }, React.createElement("button", { onClick: () => setIsRecurring(false), className: `flex-1 py-2 rounded border ${!isRecurring ? 'bg-[#004D98] text-white border-transparent' : 'bg-transparent border-gray-600'}` }, "Una fecha"), React.createElement("button", { onClick: () => setIsRecurring(true), className: `flex-1 py-2 rounded border ${isRecurring ? 'bg-[#004D98] text-white border-transparent' : 'bg-transparent border-gray-600'}` }, "Repetir")),
                                        !isRecurring ? React.createElement("input", { type: "date", className: "w-full p-3 bg-[#121212] border border-gray-600 rounded-lg text-white text-sm", value: newItemAlarmDate, onChange: e=>setNewItemAlarmDate(e.target.value) }) : React.createElement("div", { className: "bg-[#181818] p-2 rounded border border-gray-600" }, React.createElement("div", { className: "flex justify-between gap-1" }, DAYS_OF_WEEK.map(day => React.createElement("button", { key: day.id, onClick: () => toggleDay(day.id), className: `w-8 h-8 rounded-full text-[10px] font-bold flex items-center justify-center transition-all ${newItemRecurrence.includes(day.id) ? 'bg-[#004D98] text-white ring-1 ring-[#EDBB00]' : 'bg-[#121212] text-gray-500 border border-gray-700'}` }, day.label))))
                                    )
                                )
                            ),
                            React.createElement("div", null, React.createElement("label", { className: "text-xs font-bold text-gray-500 uppercase mb-1 block" }, "Prioridad"), React.createElement("div", { className: "flex gap-2" }, Object.entries(PRIORITIES).map(([k, s]) => React.createElement("button", { key: k, onClick: () => setNewItemPriority(k), className: `flex-1 py-2 text-xs font-bold rounded-lg border transition ${newItemPriority===k? s.color+' text-white border-transparent shadow-lg':'bg-[#121212] text-gray-500 border-gray-700'}` }, s.label)))),
                            activeTab === 0 && React.createElement("div", { className: "bg-[#004D98]/10 p-4 rounded-xl border border-[#004D98]/30 mt-4 flex items-center justify-between gap-2" },
                                React.createElement("div", { className: "flex flex-col items-center flex-1" }, React.createElement("span", { className: "text-xs text-gray-400 mb-1 font-bold uppercase" }, "Desde"), React.createElement("div", { className: `px-3 py-3 rounded-lg font-bold w-full text-center text-sm ${newItemFrom === 'Sara' ? 'text-purple-400 border border-purple-900/50 bg-purple-900/20' : 'text-blue-400 border border-blue-900/50 bg-blue-900/20'}` }, newItemFrom)),
                                React.createElement("button", { onClick: swapLocations, disabled: currentInventoryItem && !canSwap, className: `p-3 bg-[#1e1e1e] rounded-full border border-gray-600 hover:scale-110 transition-transform shadow-lg z-10 ${currentInventoryItem && !canSwap ? 'opacity-50 cursor-not-allowed text-gray-500' : 'text-[#EDBB00] hover:bg-gray-700'}` }, React.createElement(ArrowRightLeft, { size: 20 })),
                                React.createElement("div", { className: "flex flex-col items-center flex-1" }, React.createElement("span", { className: "text-xs text-gray-400 mb-1 font-bold uppercase" }, "Hasta"), React.createElement("div", { className: `px-3 py-3 rounded-lg font-bold w-full text-center text-sm ${newItemTo === 'Sara' ? 'text-purple-400 border border-purple-900/50 bg-purple-900/20' : 'text-blue-400 border border-blue-900/50 bg-blue-900/20'}` }, newItemTo))
                            ),
                            React.createElement("button", { onClick: saveItem, disabled: activeTab === 0 && currentInventoryItem && !isMoveQuantityValid, className: `w-full py-4 mt-2 font-bold rounded-xl shadow-lg text-lg active:scale-95 transition ${activeTab === 0 && currentInventoryItem && !isMoveQuantityValid ? 'bg-gray-700 text-gray-500 cursor-not-allowed' : 'bg-[#004D98] text-[#EDBB00]'}` }, editingItem ? (editingItem.completed && editingItem.tabId === 3 ? 'Reabastecer' : 'Guardar') : 'Agregar')
                        )
                    )
                ),
                isConsumeModalOpen && consumeItem && React.createElement("div", { className: "fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4 animate-in fade-in" },
                    React.createElement("div", { className: "bg-[#1e1e1e] w-full max-w-sm rounded-2xl p-6 border border-red-900/50" },
                        React.createElement("h3", { className: "text-xl font-bold text-red-500 mb-4 flex items-center gap-2" }, React.createElement(TrendingDown), " Registrar Gasto"),
                        React.createElement("p", { className: "text-gray-400 text-sm mb-4" }, "Restar de: ", React.createElement("strong", { className: "text-white" }, consumeItem.text)),
                        React.createElement("div", { className: "flex gap-3 mb-6" },
                            React.createElement("button", { onClick: () => setConsumeLocation('Sara'), disabled: stockSara <= 0, className: `flex-1 p-3 rounded-xl border transition-all ${consumeLocation === 'Sara' ? 'bg-purple-900/60 border-purple-500 text-white ring-2 ring-purple-500/30' : stockSara <= 0 ? 'bg-gray-800/50 border-gray-800 text-gray-600 cursor-not-allowed' : 'bg-[#121212] border-gray-700 text-gray-400 hover:bg-gray-800'}` }, React.createElement("div", { className: "text-xs font-bold uppercase mb-1" }, "Sara"), React.createElement("div", { className: "text-2xl font-bold" }, stockSara)),
                            React.createElement("button", { onClick: () => setConsumeLocation('Negocio'), disabled: stockNegocio <= 0, className: `flex-1 p-3 rounded-xl border transition-all ${consumeLocation === 'Negocio' ? 'bg-blue-900/60 border-blue-500 text-white ring-2 ring-blue-500/30' : stockNegocio <= 0 ? 'bg-gray-800/50 border-gray-800 text-gray-600 cursor-not-allowed' : 'bg-[#121212] border-gray-700 text-gray-400 hover:bg-gray-800'}` }, React.createElement("div", { className: "text-xs font-bold uppercase mb-1" }, "Negocio"), React.createElement("div", { className: "text-2xl font-bold" }, stockNegocio))
                        ),
                        React.createElement("div", { className: "relative mb-6" },
                            React.createElement("input", { type: "number", value: consumeQty, onChange: e => setConsumeQty(e.target.value), className: `w-full p-4 bg-[#121212] border rounded-xl text-white text-xl font-bold outline-none focus:ring-2 ${consumeQty && !isValidConsume ? 'border-red-500 focus:ring-red-500/30' : 'border-gray-700 focus:ring-red-500/30'}`, placeholder: "Cantidad a gastar", autoFocus: true }),
                            consumeQty && !isValidConsume && parseInt(consumeQty) > 0 && React.createElement("div", { className: "absolute top-full left-0 text-red-500 text-xs mt-1 flex items-center gap-1 font-bold" }, React.createElement(AlertTriangle, { size: 12 }), "Excede el stock disponible")
                        ),
                        React.createElement("div", { className: "flex gap-3" },
                            React.createElement("button", { onClick: () => setIsConsumeModalOpen(false), className: "flex-1 py-3 bg-gray-800 rounded-xl text-gray-300 font-bold" }, "Cancelar"),
                            React.createElement("button", { onClick: handleConsume, disabled: !isValidConsume, className: `flex-1 py-3 rounded-xl text-white font-bold transition-all ${isValidConsume ? 'bg-red-700 hover:bg-red-600 shadow-lg shadow-red-900/20' : 'bg-gray-700 text-gray-500 cursor-not-allowed'}` }, "Confirmar")
                        )
                    )
                ),
                isHistoryModalOpen && historyItem && React.createElement("div", { className: "fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4 animate-in fade-in" },
                    React.createElement("div", { className: "bg-[#1e1e1e] w-full max-w-sm rounded-2xl p-6 border border-gray-700 h-[60vh] overflow-y-auto flex flex-col" },
                        React.createElement("div", { className: "flex justify-between mb-4 border-b border-gray-700 pb-2" }, React.createElement("h3", { className: "text-[#EDBB00] font-bold text-lg" }, "Historial de Movimientos"), React.createElement("button", { onClick: () => setIsHistoryModalOpen(false) }, React.createElement(X))),
                        React.createElement("div", { className: "space-y-3" }, historyItem.history?.map((h,i) => React.createElement("div", { key: i, className: "bg-[#121212] p-3 rounded-lg border border-gray-800 text-sm text-gray-300" }, React.createElement("div", { className: "flex justify-between mb-1 text-xs text-gray-500" }, React.createElement("span", null, new Date(h.date).toLocaleString()), React.createElement("strong", { className: "uppercase text-[#004D98]" }, h.type)), React.createElement("div", { className: "font-medium" }, h.type === 'consume' ? `-${h.qty} (${h.location})` : h.type === 'exhausted' ? '⚠️ STOCK AGOTADO' : h.type === 'move' ? h.detail : `+${h.addedSara||0}S +${h.addedNegocio||0}N`))))
                    )
                ),
                isReportModalOpen && React.createElement("div", { className: "fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4 animate-in fade-in" },
                    React.createElement("div", { className: "bg-[#1e1e1e] w-full max-w-sm rounded-2xl shadow-2xl p-6 border border-gray-700" },
                        React.createElement("h3", { className: "text-lg font-bold text-[#EDBB00] mb-6 flex items-center gap-2" }, React.createElement(FileText, { size: 20 }), " Generar Reporte PDF"),
                        React.createElement("div", { className: "space-y-4" },
                            React.createElement("div", null, React.createElement("label", { className: "text-xs text-gray-400 uppercase font-bold block mb-1" }, "Desde"), React.createElement("input", { type: "date", value: reportStartDate, onChange: e=>setReportStartDate(e.target.value), className: "w-full p-3 bg-[#121212] border border-gray-700 rounded-xl text-white" })),
                            React.createElement("div", null, React.createElement("label", { className: "text-xs text-gray-400 uppercase font-bold block mb-1" }, "Hasta"), React.createElement("input", { type: "date", value: reportEndDate, onChange: e=>setReportEndDate(e.target.value), className: "w-full p-3 bg-[#121212] border border-gray-700 rounded-xl text-white" })),
                            React.createElement("div", { className: "flex gap-3 mt-6" },
                                React.createElement("button", { onClick: () => setIsReportModalOpen(false), className: "flex-1 py-3 bg-gray-800 rounded-xl font-bold text-gray-400" }, "Cancelar"),
                                React.createElement("button", { onClick: generatePDFReport, className: "flex-1 py-3 bg-[#004D98] rounded-xl font-bold text-white flex justify-center gap-2 items-center" }, React.createElement(Printer, { size: 18 }), " Imprimir")
                            )
                        )
                    )
                ),
                // File Input hidden
                React.createElement("input", { type: "file", ref: fileInputRef, onChange: importData, className: "hidden", accept: ".json" })
            );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(React.createElement(App));
    </script>
</body>
</html>