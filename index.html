<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AudioLibro Pro - Pova Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;700&display=swap');
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #020617; color: #f8fafc; }
        .glass { background: rgba(30, 41, 59, 0.5); backdrop-filter: blur(16px); border: 1px solid rgba(255,255,255,0.05); }
        .highlight-word { background: #6366f1; color: white; border-radius: 4px; padding: 0 4px; transition: all 0.1s; border-bottom: 2px solid #fff; }
        .subtitle-bar { background: linear-gradient(to top, rgba(0,0,0,0.95) 0%, rgba(0,0,0,0.8) 100%); border-top: 1px solid rgba(99, 102, 241, 0.3); }
        .active-tab { border-bottom: 3px solid #6366f1; color: #6366f1; }
        input[type="range"] { accent-color: #6366f1; }

        #textContent:empty:before {
            content: attr(placeholder);
            color: #64748b;
            cursor: text;
            display: block; 
        }

        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #1e293b; border-radius: 10px; }
        
        .reading-pulse { animation: pulse 2s infinite; }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(99, 102, 241, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(99, 102, 241, 0); }
            100% { box-shadow: 0 0 0 0 rgba(99, 102, 241, 0); }
        }

        .toast-notification {
            position: fixed;
            top: 2rem;
            left: 50%;
            transform: translateX(-50%) translateY(-150%);
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            z-index: 200;
        }
        .toast-notification.show { transform: translateX(-50%) translateY(0); }
    </style>
</head>
<body class="overflow-x-hidden pb-32">

    <!-- Toast Notification System -->
    <div id="toast" class="toast-notification bg-indigo-600 text-white px-6 py-3 rounded-2xl shadow-2xl font-bold flex items-center gap-3">
        <i class="fas fa-check-circle"></i>
        <span id="toastMessage">Texto guardado</span>
    </div>

    <div class="flex flex-col min-h-screen">
        <!-- Navegación de Pestañas -->
        <nav class="flex justify-around bg-slate-900/90 sticky top-0 z-[60] border-b border-white/5 p-2 backdrop-blur-md">
            <button onclick="switchTab('reader')" id="tabReader" class="flex-1 py-3 font-bold text-sm active-tab transition-all">
                <i class="fas fa-play-circle mr-2"></i>LECTOR
            </button>
            <button onclick="switchTab('library')" id="tabLibrary" class="flex-1 py-3 font-bold text-sm text-slate-500 transition-all">
                <i class="fas fa-books mr-2"></i>BIBLIOTECA
            </button>
        </nav>

        <!-- Contenido: Lector -->
        <main id="viewReader" class="flex-1 flex flex-col p-4 gap-4 animate-in fade-in duration-300">
            <!-- Cuadro de Texto -->
            <div class="glass rounded-[2rem] p-6 flex flex-col h-[35vh] relative">
                <div id="textContent" 
                     contenteditable="true" 
                     class="flex-1 overflow-y-auto outline-none text-lg leading-relaxed text-slate-300 custom-scrollbar" 
                     placeholder="Welcome! Paste your story here. Emma (Natural) is active. Your texts can now be saved to the library or exported as files."></div>
                <div id="wordCount" class="absolute bottom-4 right-6 text-[10px] text-slate-500 font-bold uppercase tracking-widest">0 palabras</div>
            </div>

            <!-- Panel de Rango de Páginas (Solo visible con PDF) -->
            <div id="pdfRangePanel" class="hidden glass rounded-[1.5rem] p-4 border border-indigo-500/20 animate-in slide-in-from-top-2">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <i class="fas fa-file-pdf text-red-400"></i>
                        <div>
                            <p class="text-xs font-bold text-white">Rango de Páginas</p>
                            <p id="pdfInfoLabel" class="text-[10px] text-slate-500 uppercase">Detectando páginas...</p>
                        </div>
                    </div>
                    <div class="flex items-center gap-2">
                        <input type="number" id="startPage" value="1" min="1" class="w-16 bg-slate-800 border border-white/10 rounded-lg p-2 text-xs text-center outline-none focus:ring-1 ring-indigo-500">
                        <span class="text-slate-500 text-xs">a</span>
                        <input type="number" id="endPage" value="1" min="1" class="w-16 bg-slate-800 border border-white/10 rounded-lg p-2 text-xs text-center outline-none focus:ring-1 ring-indigo-500">
                        <button onclick="processPdfRange()" class="bg-indigo-600 px-3 py-2 rounded-lg text-[10px] font-bold">CARGAR</button>
                    </div>
                </div>
            </div>

            <!-- Panel de Controles -->
            <div class="glass rounded-[2rem] p-6 space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="space-y-1">
                        <label class="text-[10px] font-bold text-slate-500 ml-1 tracking-widest uppercase">Narrador Seleccionado</label>
                        <select id="voiceSelect" onchange="warmUpVoice()" class="w-full bg-slate-800 p-4 rounded-2xl text-xs outline-none border-none ring-1 ring-white/10 text-indigo-100"></select>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-3">
                        <div class="space-y-1">
                            <label class="text-[10px] font-bold text-slate-500 ml-1 tracking-widest uppercase">Volumen</label>
                            <div class="flex items-center gap-2 bg-slate-800 p-3.5 rounded-2xl ring-1 ring-white/5">
                                <i class="fas fa-volume-up text-xs text-slate-500"></i>
                                <input type="range" id="volumeRange" min="0" max="1" step="0.1" value="1" class="flex-1">
                            </div>
                        </div>
                        <div class="space-y-1">
                            <label class="text-[10px] font-bold text-slate-500 ml-1 tracking-widest uppercase">Velocidad</label>
                            <div class="flex items-center gap-2 bg-slate-800 p-3.5 rounded-2xl ring-1 ring-white/5">
                                <input type="range" id="speedRange" min="0.5" max="2" step="0.1" value="1" class="flex-1">
                                <span id="speedValue" class="text-xs font-bold text-indigo-400 w-6">1.0</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="flex flex-col gap-4">
                    <div class="flex items-center justify-center gap-4">
                        <!-- Botón Exportar Texto -->
                        <button id="exportBtn" onclick="exportTextAsFile()" title="Exportar como archivo .txt" class="w-14 h-14 rounded-full bg-slate-800 flex flex-col items-center justify-center text-indigo-400 hover:text-white transition-all active:scale-90 border border-white/5 gap-1">
                            <i class="fas fa-file-export text-xs"></i>
                            <span class="text-[8px] font-bold uppercase">Txt</span>
                        </button>
                        
                        <button id="playBtn" onclick="handlePlay()" class="flex-1 max-w-xs bg-indigo-600 py-5 rounded-[2rem] font-bold text-lg shadow-xl shadow-indigo-900/40 active:scale-95 transition-all flex items-center justify-center gap-3">
                            <i class="fas fa-play"></i> REPRODUCIR
                        </button>

                        <button id="saveBtn" onclick="saveCurrentToLibrary()" title="Guardar en Biblioteca" class="w-14 h-14 rounded-full bg-slate-800 flex items-center justify-center text-indigo-400 hover:text-white transition-all active:scale-90 border border-white/5">
                            <i class="fas fa-bookmark"></i>
                        </button>
                    </div>

                    <div class="flex gap-3">
                        <label class="flex-1 bg-slate-800/50 py-4 rounded-2xl text-[10px] font-bold text-slate-300 border border-white/5 active:scale-95 transition-all flex items-center justify-center gap-2 cursor-pointer">
                            <i class="fas fa-file-pdf text-red-400"></i> IMPORTAR LIBRO (PDF/TXT)
                            <input type="file" id="fileInput" class="hidden" accept=".pdf,.txt">
                        </label>
                    </div>
                </div>
            </div>
        </main>

        <!-- Contenido: Biblioteca -->
        <section id="viewLibrary" class="hidden flex-1 p-4 animate-in slide-in-from-right duration-300">
            <h2 class="text-xl font-bold mb-6 px-2 flex items-center gap-2">
                <i class="fas fa-layer-group text-indigo-500"></i> Mi Biblioteca
            </h2>
            <div id="libraryList" class="space-y-4">
                <div class="p-12 text-center text-slate-600 italic">No hay libros guardados todavía.</div>
            </div>
        </section>

        <!-- Barra de Subtítulos -->
        <div id="subtitleBar" class="fixed bottom-0 left-0 w-full p-8 subtitle-bar transform translate-y-full transition-all duration-500 z-[100] backdrop-blur-xl">
            <div class="max-w-4xl mx-auto flex flex-col gap-4">
                <div id="subtitleText" class="text-center text-2xl font-bold leading-tight text-white drop-shadow-md"></div>
                
                <div class="flex justify-center items-center gap-8 mt-2">
                    <button onclick="skipSeconds(-10)" class="text-slate-400 hover:text-white"><i class="fas fa-undo-alt text-xl"></i></button>
                    <button onclick="handlePlay()" id="miniPlayBtn" class="w-14 h-14 bg-white text-black rounded-full flex items-center justify-center shadow-lg active:scale-90">
                        <i class="fas fa-pause text-xl"></i>
                    </button>
                    <button onclick="skipSeconds(10)" class="text-slate-400 hover:text-white"><i class="fas fa-redo-alt text-xl"></i></button>
                </div>
            </div>
        </div>

        <!-- Audio Silencioso para Segundo Plano -->
        <audio id="silentAudio" loop src="data:audio/wav;base64,UklGRigAAABXQVZFlm10IBAAAAABAAEARKwAAIhAAQACABAAZGF0YQQAAAAAAA=="></audio>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, doc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-id';

        let user = null;
        let libraryData = [];

        signInAnonymously(auth);
        onAuthStateChanged(auth, (u) => {
            user = u;
            if (user) loadLibrary();
        });

        function loadLibrary() {
            const q = collection(db, 'artifacts', appId, 'users', user.uid, 'library');
            onSnapshot(q, (snapshot) => {
                libraryData = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                renderLibrary();
            }, (err) => console.error("Firestore Error:", err));
        }

        window.saveCurrentToLibrary = async () => {
            const text = document.getElementById('textContent').innerText.trim();
            if (!text || !user) {
                showToast("Por favor ingresa texto antes de guardar", true);
                return;
            }
            const title = text.substring(0, 40).replace(/\n/g, " ") + "...";
            try {
                await addDoc(collection(db, 'artifacts', appId, 'users', user.uid, 'library'), {
                    title, text, date: new Date().toISOString()
                });
                showToast("¡Libro guardado en la biblioteca!");
            } catch (e) {
                showToast("Error al guardar en la biblioteca", true);
            }
        };

        window.deleteFromLibrary = async (id) => {
            try {
                await deleteDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'library', id));
                showToast("Libro eliminado");
            } catch (e) {
                showToast("Error al eliminar", true);
            }
        };

        function renderLibrary() {
            const list = document.getElementById('libraryList');
            if (libraryData.length === 0) {
                list.innerHTML = `<div class="p-12 text-center text-slate-600">No hay libros guardados.</div>`;
                return;
            }
            list.innerHTML = libraryData.map(item => `
                <div class="glass p-6 rounded-[2rem] flex justify-between items-center gap-4 animate-in fade-in slide-in-from-bottom-2">
                    <div class="flex-1 cursor-pointer" onclick="loadToReader('${item.id}')">
                        <h4 class="font-bold text-slate-100 text-lg">${item.title}</h4>
                        <p class="text-[10px] text-indigo-400 font-bold mt-1 uppercase tracking-tighter">
                            <i class="far fa-clock mr-1"></i> ${new Date(item.date).toLocaleDateString()}
                        </p>
                    </div>
                    <button onclick="deleteFromLibrary('${item.id}')" class="bg-red-500/10 text-red-400 w-10 h-10 rounded-full flex items-center justify-center hover:bg-red-500 hover:text-white transition-all">
                        <i class="fas fa-trash-alt text-xs"></i>
                    </button>
                </div>
            `).join('');
        }

        window.loadToReader = (id) => {
            const item = libraryData.find(d => d.id === id);
            document.getElementById('textContent').innerText = item.text;
            switchTab('reader');
            updateWordCount();
            showToast("Libro cargado");
        };

        // Utility: Show Toast
        window.showToast = (msg, isError = false) => {
            const toast = document.getElementById('toast');
            const toastMsg = document.getElementById('toastMessage');
            toastMsg.innerText = msg;
            toast.classList.remove('bg-indigo-600', 'bg-red-600');
            toast.classList.add(isError ? 'bg-red-600' : 'bg-indigo-600');
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        };
    </script>

    <script>
        const synth = window.speechSynthesis;
        const voiceSelect = document.getElementById('voiceSelect');
        const textContent = document.getElementById('textContent');
        const speedRange = document.getElementById('speedRange');
        const speedValue = document.getElementById('speedValue');
        const volumeRange = document.getElementById('volumeRange');
        const subtitleBar = document.getElementById('subtitleBar');
        const subtitleText = document.getElementById('subtitleText');
        const playBtn = document.getElementById('playBtn');
        const miniPlayBtn = document.getElementById('miniPlayBtn');
        const silentAudio = document.getElementById('silentAudio');

        let voices = [];
        let currentUtterance = null;
        let lastCharIndex = 0;
        let currentPdf = null;

        // --- MOTOR DE VOZ ---
        function initVoices() {
            voices = synth.getVoices();
            if (voices.length === 0) return;

            voiceSelect.innerHTML = '';
            const sortedVoices = voices.sort((a, b) => {
                if (a.name.includes('Emma')) return -1;
                if (a.name.includes('Natural') && !b.name.includes('Natural')) return -1;
                return 0;
            });

            sortedVoices.forEach(v => {
                const opt = document.createElement('option');
                opt.value = v.name;
                opt.textContent = v.name.replace('Microsoft ', '').replace('Online (Natural)', 'Natural ✨');
                voiceSelect.appendChild(opt);
                if (v.name.includes('Emma')) opt.selected = true;
            });
            warmUpVoice();
        }

        function warmUpVoice() {
            synth.cancel();
            const warmUp = new SpeechSynthesisUtterance("");
            const selected = voices.find(v => v.name === voiceSelect.value);
            if (selected) warmUp.voice = selected;
            warmUp.volume = 0;
            synth.speak(warmUp);
        }

        if (speechSynthesis.onvoiceschanged !== undefined) {
            speechSynthesis.onvoiceschanged = initVoices;
        }
        initVoices();

        // --- EXPORTAR TEXTO ---
        function exportTextAsFile() {
            const text = textContent.innerText.trim();
            if (!text) {
                showToast("No hay texto para exportar", true);
                return;
            }
            const blob = new Blob([text], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `libro_exportado_${Date.now()}.txt`;
            a.click();
            URL.revokeObjectURL(url);
            showToast("Archivo .txt descargado");
        }

        // --- MANEJO DE PDF Y RANGO ---
        async function processPdfRange() {
            if (!currentPdf) return;
            const start = parseInt(document.getElementById('startPage').value);
            const end = parseInt(document.getElementById('endPage').value);
            
            if (start < 1 || end > currentPdf.numPages || start > end) {
                showToast("Rango de páginas inválido", true);
                return;
            }

            textContent.innerText = "Procesando páginas...";
            let fullText = "";
            for (let i = start; i <= end; i++) {
                const page = await currentPdf.getPage(i);
                const content = await page.getTextContent();
                fullText += content.items.map(item => item.str).join(" ") + " ";
            }
            textContent.innerText = fullText.replace(/\s+/g, ' ').trim();
            updateWordCount();
            showToast(`Páginas ${start}-${end} cargadas`);
        }

        // --- REPRODUCCIÓN ---
        function handlePlay() {
            if (synth.speaking) {
                if (synth.paused) {
                    synth.resume();
                    updateUI(true);
                } else {
                    synth.pause();
                    updateUI(false);
                }
                return;
            }

            const text = textContent.innerText.trim();
            if (!text) return;
            startSpeaking(text, 0);
        }

        function startSpeaking(text, fromIndex) {
            synth.cancel();
            silentAudio.play().catch(() => {});

            const remainingText = text.substring(fromIndex);
            currentUtterance = new SpeechSynthesisUtterance(remainingText);
            
            const selectedVoice = voices.find(v => v.name === voiceSelect.value);
            if (selectedVoice) currentUtterance.voice = selectedVoice;
            
            currentUtterance.rate = parseFloat(speedRange.value);
            currentUtterance.volume = parseFloat(volumeRange.value);

            currentUtterance.onboundary = (e) => {
                if (e.name === 'word') {
                    const globalIndex = fromIndex + e.charIndex;
                    lastCharIndex = globalIndex;
                    updateSubtitles(text, globalIndex);
                }
            };

            currentUtterance.onend = () => {
                if (!synth.paused) stopPlayback();
            };

            subtitleBar.classList.remove('translate-y-full');
            updateUI(true);
            
            if ('mediaSession' in navigator) {
                navigator.mediaSession.metadata = new MediaMetadata({
                    title: 'Lector Pova',
                    artist: voiceSelect.value,
                    album: 'Biblioteca'
                });
                navigator.mediaSession.setActionHandler('play', () => { synth.resume(); updateUI(true); });
                navigator.mediaSession.setActionHandler('pause', () => { synth.pause(); updateUI(false); });
                navigator.mediaSession.setActionHandler('stop', stopPlayback);
            }

            synth.speak(currentUtterance);
        }

        function stopPlayback() {
            synth.cancel();
            subtitleBar.classList.add('translate-y-full');
            updateUI(false);
            textContent.innerHTML = textContent.innerText;
            silentAudio.pause();
        }

        function skipSeconds(seconds) {
            const charStep = seconds * 15 * parseFloat(speedRange.value);
            const newIndex = Math.max(0, lastCharIndex + charStep);
            startSpeaking(textContent.innerText, Math.floor(newIndex));
        }

        function updateUI(playing) {
            playBtn.innerHTML = playing ? '<i class="fas fa-pause mr-2"></i> PAUSAR' : '<i class="fas fa-play mr-2"></i> REPRODUCIR';
            playBtn.className = playing 
                ? "flex-1 max-w-xs bg-amber-500 py-5 rounded-[2rem] font-bold text-lg shadow-xl reading-pulse"
                : "flex-1 max-w-xs bg-indigo-600 py-5 rounded-[2rem] font-bold text-lg shadow-xl";
            miniPlayBtn.innerHTML = playing ? '<i class="fas fa-pause text-xl"></i>' : '<i class="fas fa-play text-xl ml-1"></i>';
        }

        function updateSubtitles(fullText, index) {
            const contextSize = 70;
            let start = Math.max(0, index - contextSize / 2);
            let end = Math.min(fullText.length, index + contextSize / 2);
            while (start > 0 && fullText[start] !== ' ') start--;
            while (end < fullText.length && fullText[end] !== ' ') end++;
            const phrase = fullText.substring(start, end);
            const relIndex = index - start;
            let wordEnd = phrase.indexOf(' ', relIndex);
            if (wordEnd === -1) wordEnd = phrase.length;
            const b = phrase.substring(0, relIndex);
            const w = phrase.substring(relIndex, wordEnd);
            const a = phrase.substring(wordEnd);
            subtitleText.innerHTML = `<span class="opacity-30">${b}</span> <span class="text-indigo-400 underline decoration-2 underline-offset-8">${w}</span> <span class="opacity-30">${a}</span>`;
        }

        // --- UTILIDADES ---
        function switchTab(tab) {
            document.getElementById('viewReader').classList.toggle('hidden', tab !== 'reader');
            document.getElementById('viewLibrary').classList.toggle('hidden', tab !== 'library');
            document.getElementById('tabReader').className = tab === 'reader' ? 'flex-1 py-3 font-bold text-sm active-tab transition-all' : 'flex-1 py-3 font-bold text-sm text-slate-500 transition-all';
            document.getElementById('tabLibrary').className = tab === 'library' ? 'flex-1 py-3 font-bold text-sm active-tab transition-all' : 'flex-1 py-3 font-bold text-sm text-slate-500 transition-all';
        }

        function updateWordCount() {
            const text = textContent.innerText.trim();
            const count = text ? text.split(/\s+/).length : 0;
            document.getElementById('wordCount').textContent = `${count} palabras`;
        }

        textContent.addEventListener('input', updateWordCount);
        speedRange.oninput = () => speedValue.textContent = speedRange.value;

        // PDF y archivos
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';
        document.getElementById('fileInput').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            if (file.type === "application/pdf") {
                const arrayBuffer = await file.arrayBuffer();
                currentPdf = await pdfjsLib.getDocument(arrayBuffer).promise;
                document.getElementById('pdfRangePanel').classList.remove('hidden');
                document.getElementById('pdfInfoLabel').textContent = `Documento: ${currentPdf.numPages} páginas totales`;
                document.getElementById('startPage').value = 1;
                document.getElementById('endPage').value = currentPdf.numPages;
                document.getElementById('endPage').max = currentPdf.numPages;
                processPdfRange();
            } else {
                const r = new FileReader();
                r.onload = (ev) => {
                    textContent.innerText = ev.target.result;
                    document.getElementById('pdfRangePanel').classList.add('hidden');
                    updateWordCount();
                };
                r.readAsText(file);
            }
        });
    </script>
</body>
</html>