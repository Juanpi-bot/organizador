<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AudioLibro Pro - Pova Universal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;700&display=swap');
        
        :root {
            --bg-deep: #020617;
            --accent: #6366f1;
            --glass: rgba(30, 41, 59, 0.5);
        }

        body { 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            background-color: var(--bg-deep); 
            color: #f8fafc;
            margin: 0;
            padding: 0;
            overflow-x: hidden;
        }

        .glass { 
            background: var(--glass); 
            backdrop-filter: blur(16px); 
            border: 1px solid rgba(255,255,255,0.05); 
        }

        .highlight-word { 
            background: var(--accent); 
            color: white; 
            border-radius: 4px; 
            padding: 2px 6px; 
            transition: all 0.1s; 
            box-shadow: 0 0 15px rgba(99, 102, 241, 0.5);
        }

        .active-tab { 
            color: var(--accent);
            background: rgba(99, 102, 241, 0.15);
        }
        
        input[type="range"] { 
            accent-color: var(--accent);
            height: 6px;
        }

        #textContent:empty:before {
            content: attr(placeholder);
            color: #64748b;
            cursor: text;
            display: block; 
        }

        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #1e293b; border-radius: 10px; }
        
        .reading-pulse { animation: pulse 2s infinite; }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(99, 102, 241, 0.4); }
            70% { box-shadow: 0 0 0 12px rgba(99, 102, 241, 0); }
            100% { box-shadow: 0 0 0 0 rgba(99, 102, 241, 0); }
        }

        .toast-notification {
            position: fixed;
            top: 1rem;
            left: 50%;
            transform: translateX(-50%) translateY(-200%);
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            z-index: 999;
        }
        .toast-notification.show { transform: translateX(-50%) translateY(0); }
    </style>
</head>
<body class="flex flex-col h-screen">

    <div id="toast" class="toast-notification glass text-white px-6 py-3 rounded-full shadow-2xl font-bold flex items-center gap-3">
        <i class="fas fa-check-circle text-indigo-400"></i>
        <span id="toastMessage">Listo</span>
    </div>

    <!-- Navegación Superior -->
    <header class="glass sticky top-0 z-[100] border-b border-white/5 shadow-2xl">
        <div class="max-w-6xl mx-auto px-4 py-3 flex flex-row items-center justify-between gap-4">
            <div class="flex items-center gap-2 flex-shrink-0">
                <div class="w-8 h-8 bg-indigo-600 rounded-lg flex items-center justify-center">
                    <i class="fas fa-headphones-simple text-sm"></i>
                </div>
                <h1 class="font-bold text-base tracking-tight hidden xs:block">Pova <span class="text-indigo-400">Audio</span></h1>
            </div>
            
            <nav class="flex flex-1 max-w-[300px] bg-white/5 rounded-2xl p-1 gap-1">
                <button onclick="switchTab('reader')" id="tabReader" class="flex-1 py-2 rounded-xl font-bold text-[10px] sm:text-xs active-tab transition-all flex items-center justify-center gap-2">
                    <i class="fas fa-play-circle"></i>LECTOR
                </button>
                <button onclick="switchTab('library')" id="tabLibrary" class="flex-1 py-2 rounded-xl font-bold text-[10px] sm:text-xs text-slate-400 transition-all flex items-center justify-center gap-2">
                    <i class="fas fa-books"></i>BIBLIOTECA
                </button>
            </nav>
        </div>
    </header>

    <main class="flex-1 overflow-y-auto custom-scrollbar p-4 sm:p-6">
        <div class="max-w-4xl mx-auto space-y-4 pb-24">
            
            <div id="viewReader" class="space-y-4 animate-in fade-in duration-300">
                <!-- Área de Texto -->
                <div class="glass rounded-[1.5rem] p-5 flex flex-col h-[35vh] sm:h-[40vh] relative shadow-inner">
                    <div id="textContent" 
                         contenteditable="true" 
                         class="flex-1 overflow-y-auto outline-none text-lg leading-relaxed text-slate-300 custom-scrollbar pr-2" 
                         placeholder="Pega tu texto aquí. Microsoft Emma se activará automáticamente al detectar voces."></div>
                    <div class="absolute bottom-4 right-6 flex items-center gap-3 bg-slate-900/90 px-3 py-1.5 rounded-full border border-white/5">
                         <span id="wordCount" class="text-[9px] text-slate-400 font-bold uppercase tracking-widest">0 palabras</span>
                         <button onclick="clearContent()" class="text-slate-400 hover:text-red-400 transition-colors"><i class="fas fa-eraser"></i></button>
                    </div>
                </div>

                <!-- BOTÓN PRINCIPAL DE REPRODUCCIÓN (Debajo del texto) -->
                <button id="playBtn" onclick="handlePlay()" class="w-full bg-indigo-600 py-5 rounded-[1.5rem] font-bold text-base shadow-xl shadow-indigo-600/20 active:scale-95 transition-all flex items-center justify-center gap-4">
                    <i class="fas fa-play"></i> REPRODUCIR LIBRO
                </button>

                <!-- Panel PDF (Solo si hay un PDF cargado) -->
                <div id="pdfRangePanel" class="hidden glass rounded-[1.5rem] p-4 border border-indigo-500/20">
                    <div class="flex flex-col sm:flex-row items-center justify-between gap-4 text-center sm:text-left">
                        <div class="flex items-center gap-3">
                            <i class="fas fa-file-pdf text-red-500 text-xl"></i>
                            <div>
                                <p class="text-[10px] font-bold text-white uppercase tracking-wider">Rango del PDF</p>
                                <p id="pdfInfoLabel" class="text-[9px] text-slate-500 uppercase">Detectando...</p>
                            </div>
                        </div>
                        <div class="flex items-center gap-2 w-full sm:w-auto justify-center">
                            <input type="number" id="startPage" class="w-12 bg-slate-900 border border-white/10 rounded-lg p-2 text-xs text-center outline-none">
                            <span class="text-slate-500 text-xs">a</span>
                            <input type="number" id="endPage" class="w-12 bg-slate-900 border border-white/10 rounded-lg p-2 text-xs text-center outline-none">
                            <button onclick="processPdfRange()" class="bg-indigo-600/20 text-indigo-400 border border-indigo-500/30 px-4 py-2 rounded-lg text-[10px] font-bold">CARGAR</button>
                        </div>
                    </div>
                </div>

                <!-- Panel de Configuración Secundario -->
                <div class="glass rounded-[1.5rem] p-5 space-y-5 shadow-2xl">
                    <div class="space-y-4">
                        <!-- Narrador -->
                        <div class="space-y-2">
                            <div class="flex justify-between items-center px-1">
                                <label class="text-[9px] font-bold text-slate-500 tracking-widest uppercase">Narrador (Emma Natural ✨)</label>
                                <button onclick="initVoices()" class="text-[9px] text-indigo-400 font-bold uppercase"><i class="fas fa-sync-alt mr-1"></i>Refrescar</button>
                            </div>
                            <select id="voiceSelect" onchange="warmUpVoice()" class="w-full bg-slate-900/50 p-3.5 rounded-xl text-xs outline-none border border-white/5 text-indigo-100"></select>
                        </div>
                        
                        <!-- Volumen y Velocidad (Apilados en móvil) -->
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <div class="space-y-2">
                                <label class="text-[9px] font-bold text-slate-500 tracking-widest uppercase flex justify-between px-1">
                                    <span>Volumen</span>
                                    <span id="volVal" class="text-indigo-400">100%</span>
                                </label>
                                <div class="flex items-center gap-3 bg-slate-900/50 p-3.5 rounded-xl border border-white/5">
                                    <i class="fas fa-volume-high text-xs text-slate-500"></i>
                                    <input type="range" id="volumeRange" min="0" max="1" step="0.1" value="1" class="flex-1" oninput="document.getElementById('volVal').innerText = Math.round(this.value*100)+'%'">
                                </div>
                            </div>
                            <div class="space-y-2">
                                <label class="text-[9px] font-bold text-slate-500 tracking-widest uppercase flex justify-between px-1">
                                    <span>Velocidad</span>
                                    <span id="speedValue" class="text-indigo-400">1.0x</span>
                                </label>
                                <div class="flex items-center gap-3 bg-slate-900/50 p-3.5 rounded-xl border border-white/5">
                                    <i class="fas fa-gauge-high text-xs text-slate-500"></i>
                                    <input type="range" id="speedRange" min="0.5" max="2" step="0.1" value="1" class="flex-1">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Acciones de Archivo -->
                    <div class="grid grid-cols-3 gap-3 pt-2">
                        <button onclick="saveCurrentToLibrary()" class="flex flex-col items-center justify-center gap-2 bg-slate-800/40 py-3 rounded-xl border border-white/5 active:scale-95 transition-all">
                            <i class="fas fa-bookmark text-indigo-400"></i>
                            <span class="text-[9px] font-bold uppercase">Guardar</span>
                        </button>
                        <label class="flex flex-col items-center justify-center gap-2 bg-slate-800/40 py-3 rounded-xl border border-white/5 cursor-pointer active:scale-95 transition-all text-center">
                            <i class="fas fa-file-pdf text-red-400"></i>
                            <span class="text-[9px] font-bold uppercase">Importar</span>
                            <input type="file" id="fileInput" class="hidden" accept=".pdf,.txt">
                        </label>
                        <button onclick="exportTextAsFile()" class="flex flex-col items-center justify-center gap-2 bg-slate-800/40 py-3 rounded-xl border border-white/5 active:scale-95 transition-all">
                            <i class="fas fa-file-export text-emerald-400"></i>
                            <span class="text-[9px] font-bold uppercase">Exportar</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Vista Biblioteca -->
            <div id="viewLibrary" class="hidden space-y-4 animate-in slide-in-from-right duration-300">
                <h2 class="text-xl font-bold flex items-center gap-3 px-2">
                    <i class="fas fa-book-bookmark text-indigo-500"></i> Mi Biblioteca
                </h2>
                <div id="libraryList" class="grid grid-cols-1 sm:grid-cols-2 gap-3"></div>
            </div>
        </div>
    </main>

    <!-- Barra de Subtítulos (Teleprompter) -->
    <div id="subtitleBar" class="fixed bottom-0 left-0 w-full p-6 subtitle-bar transform translate-y-full transition-all duration-500 z-[110] backdrop-blur-3xl border-t border-white/10 shadow-[0_-20px_50px_rgba(0,0,0,0.5)]">
        <div class="max-w-4xl mx-auto space-y-6">
            <div id="subtitleText" class="text-center text-lg sm:text-2xl font-bold leading-tight text-white px-2"></div>
            <div class="flex justify-center items-center gap-10">
                <button onclick="skipSeconds(-10)" class="text-slate-400 p-2 active:text-indigo-400"><i class="fas fa-backward-step text-2xl"></i></button>
                <button onclick="handlePlay()" id="miniPlayBtn" class="w-16 h-16 bg-white text-black rounded-full flex items-center justify-center shadow-2xl active:scale-90 transition-all">
                    <i class="fas fa-pause text-2xl"></i>
                </button>
                <button onclick="skipSeconds(10)" class="text-slate-400 p-2 active:text-indigo-400"><i class="fas fa-forward-step text-2xl"></i></button>
            </div>
        </div>
    </div>

    <!-- Audio Silencioso para Segundo Plano -->
    <audio id="silentAudio" loop src="data:audio/wav;base64,UklGRigAAABXQVZFlm10IBAAAAABAAEARKwAAIhAAQACABAAZGF0YQQAAAAAAA=="></audio>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, doc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-id';

        let user = null;
        let libraryData = [];

        signInAnonymously(auth);
        onAuthStateChanged(auth, (u) => {
            user = u;
            if (user) loadLibrary();
        });

        function loadLibrary() {
            const q = collection(db, 'artifacts', appId, 'users', user.uid, 'library');
            onSnapshot(q, (snapshot) => {
                libraryData = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                renderLibrary();
            });
        }

        window.saveCurrentToLibrary = async () => {
            const text = document.getElementById('textContent').innerText.trim();
            if (!text || !user) return showToast("Sin texto", true);
            const title = text.substring(0, 45).replace(/\n/g, " ") + "...";
            await addDoc(collection(db, 'artifacts', appId, 'users', user.uid, 'library'), {
                title, text, date: new Date().toISOString()
            });
            showToast("Guardado");
        };

        window.deleteFromLibrary = async (id) => {
            await deleteDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'library', id));
            showToast("Eliminado");
        };

        function renderLibrary() {
            const list = document.getElementById('libraryList');
            if (libraryData.length === 0) {
                list.innerHTML = `<div class="col-span-full p-12 text-center text-slate-600 italic">Vacío</div>`;
                return;
            }
            list.innerHTML = libraryData.map(item => `
                <div class="glass p-4 rounded-[1.2rem] flex justify-between items-center gap-3">
                    <div class="flex-1 cursor-pointer overflow-hidden" onclick="loadToReader('${item.id}')">
                        <h4 class="font-bold text-slate-100 text-[13px] truncate">${item.title}</h4>
                        <p class="text-[8px] text-indigo-400 font-bold uppercase mt-1">Guardado: ${new Date(item.date).toLocaleDateString()}</p>
                    </div>
                    <button onclick="deleteFromLibrary('${item.id}')" class="text-slate-600 hover:text-red-400 p-2"><i class="fas fa-trash-can text-xs"></i></button>
                </div>
            `).join('');
        }

        window.loadToReader = (id) => {
            const item = libraryData.find(d => d.id === id);
            document.getElementById('textContent').innerText = item.text;
            switchTab('reader');
            updateWordCount();
        };

        window.showToast = (msg, isError = false) => {
            const toast = document.getElementById('toast');
            document.getElementById('toastMessage').innerText = msg;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 2500);
        };
    </script>

    <script>
        const synth = window.speechSynthesis;
        const voiceSelect = document.getElementById('voiceSelect');
        const textContent = document.getElementById('textContent');
        const speedRange = document.getElementById('speedRange');
        const speedValue = document.getElementById('speedValue');
        const volumeRange = document.getElementById('volumeRange');
        const subtitleBar = document.getElementById('subtitleBar');
        const subtitleText = document.getElementById('subtitleText');
        const playBtn = document.getElementById('playBtn');
        const miniPlayBtn = document.getElementById('miniPlayBtn');
        const silentAudio = document.getElementById('silentAudio');

        let voices = [];
        let currentUtterance = null;
        let lastCharIndex = 0;
        let currentPdf = null;

        // Solución robusta para carga de voces
        function initVoices() {
            voices = synth.getVoices();
            if (voices.length === 0) {
                setTimeout(initVoices, 100);
                return;
            }

            voiceSelect.innerHTML = '';
            // Filtrar y Priorizar Microsoft Emma Online (Natural)
            const filtered = voices.filter(v => v.lang.startsWith('en') || v.lang.startsWith('es'));
            
            filtered.sort((a, b) => {
                const nameA = a.name.toLowerCase();
                const nameB = b.name.toLowerCase();
                if (nameA.includes('emma')) return -1;
                if (nameB.includes('emma')) return 1;
                if (nameA.includes('natural') && !nameB.includes('natural')) return -1;
                if (!nameA.includes('natural') && nameB.includes('natural')) return 1;
                return 0;
            }).forEach(v => {
                const opt = document.createElement('option');
                opt.value = v.name;
                opt.textContent = v.name.replace('Microsoft ', '').replace('Online (Natural)', '✨');
                voiceSelect.appendChild(opt);
                if (v.name.includes('Emma')) opt.selected = true;
            });
            warmUpVoice();
        }

        if (speechSynthesis.onvoiceschanged !== undefined) {
            speechSynthesis.onvoiceschanged = initVoices;
        }
        initVoices();

        function warmUpVoice() {
            synth.cancel();
            const wu = new SpeechSynthesisUtterance("");
            const s = voices.find(v => v.name === voiceSelect.value);
            if (s) wu.voice = s;
            wu.volume = 0;
            synth.speak(wu);
        }

        function handlePlay() {
            if (synth.speaking) {
                if (synth.paused) { synth.resume(); updateUI(true); }
                else { synth.pause(); updateUI(false); }
                return;
            }
            const txt = textContent.innerText.trim();
            if (txt) startSpeaking(txt, 0);
        }

        function startSpeaking(text, fromIndex) {
            synth.cancel();
            silentAudio.play().catch(()=>{});

            const remaining = text.substring(fromIndex);
            currentUtterance = new SpeechSynthesisUtterance(remaining);
            const v = voices.find(vo => vo.name === voiceSelect.value);
            if (v) currentUtterance.voice = v;
            
            currentUtterance.rate = parseFloat(speedRange.value);
            currentUtterance.volume = parseFloat(volumeRange.value);

            currentUtterance.onboundary = (e) => {
                if (e.name === 'word') {
                    lastCharIndex = fromIndex + e.charIndex;
                    updateSubtitles(text, lastCharIndex);
                }
            };

            currentUtterance.onend = () => { if(!synth.paused) stopPlayback(); };
            
            subtitleBar.classList.remove('translate-y-full');
            updateUI(true);
            
            if ('mediaSession' in navigator) {
                navigator.mediaSession.metadata = new MediaMetadata({
                    title: 'Lector AudioLibro',
                    artist: voiceSelect.value || 'Pova Voice'
                });
                navigator.mediaSession.setActionHandler('play', () => { synth.resume(); updateUI(true); });
                navigator.mediaSession.setActionHandler('pause', () => { synth.pause(); updateUI(false); });
            }

            synth.speak(currentUtterance);
        }

        function stopPlayback() {
            synth.cancel();
            subtitleBar.classList.add('translate-y-full');
            updateUI(false);
            textContent.innerHTML = textContent.innerText;
            silentAudio.pause();
        }

        function updateUI(playing) {
            playBtn.innerHTML = playing ? '<i class="fas fa-pause mr-2"></i> PAUSAR LECTURA' : '<i class="fas fa-play mr-2"></i> REPRODUCIR LIBRO';
            playBtn.className = playing 
                ? "w-full bg-amber-500 py-5 rounded-[1.5rem] font-bold text-base shadow-xl reading-pulse flex items-center justify-center gap-4 transition-all"
                : "w-full bg-indigo-600 py-5 rounded-[1.5rem] font-bold text-base shadow-xl flex items-center justify-center gap-4 transition-all";
            miniPlayBtn.innerHTML = playing ? '<i class="fas fa-pause"></i>' : '<i class="fas fa-play ml-1"></i>';
        }

        function updateSubtitles(fullText, index) {
            const context = 60;
            let start = Math.max(0, index - context / 2);
            let end = Math.min(fullText.length, index + context / 2);
            while (start > 0 && fullText[start] !== ' ') start--;
            while (end < fullText.length && fullText[end] !== ' ') end++;
            
            const phrase = fullText.substring(start, end);
            const relIdx = index - start;
            let wordEnd = phrase.indexOf(' ', relIdx);
            if (wordEnd === -1) wordEnd = phrase.length;
            
            const b = phrase.substring(0, relIdx);
            const w = phrase.substring(relIdx, wordEnd);
            const a = phrase.substring(wordEnd);
            
            subtitleText.innerHTML = `<span class="opacity-30 text-sm sm:text-lg">${b}</span> <span class="text-indigo-400 underline decoration-2 underline-offset-4">${w}</span> <span class="opacity-30 text-sm sm:text-lg">${a}</span>`;
            
            const mainB = fullText.substring(0, index);
            const mainW = fullText.substring(index, index + w.length);
            const mainA = fullText.substring(index + w.length);
            textContent.innerHTML = `${mainB}<span class="highlight-word">${mainW}</span>${mainA}`;
            
            const h = textContent.querySelector('.highlight-word');
            if (h) h.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        async function processPdfRange() {
            if (!currentPdf) return;
            const s = parseInt(document.getElementById('startPage').value);
            const e = parseInt(document.getElementById('endPage').value);
            if (isNaN(s) || isNaN(e)) return;
            
            textContent.innerText = "Cargando páginas del PDF...";
            let t = "";
            for (let i = s; i <= e; i++) {
                try {
                    const p = await currentPdf.getPage(i);
                    const c = await p.getTextContent();
                    // Limpieza agresiva de espacios y saltos de línea para que lea bien
                    t += c.items.map(it => it.str).join(" ").replace(/\s+/g, ' ') + " ";
                } catch (pdfErr) {
                    console.error("Error en página " + i, pdfErr);
                }
            }
            textContent.innerText = t.trim();
            updateWordCount();
        }

        function clearContent() { textContent.innerText = ""; updateWordCount(); }
        function skipSeconds(sec) {
            const step = sec * 15 * parseFloat(speedRange.value);
            startSpeaking(textContent.innerText, Math.floor(Math.max(0, lastCharIndex + step)));
        }
        function updateWordCount() {
            const t = textContent.innerText.trim();
            document.getElementById('wordCount').textContent = (t ? t.split(/\s+/).length : 0) + " palabras";
        }
        function exportTextAsFile() {
            const t = textContent.innerText.trim();
            if (!t) return;
            const b = new Blob([t], { type: 'text/plain' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(b);
            a.download = `pova_libro.txt`;
            a.click();
        }

        function switchTab(tab) {
            const reader = document.getElementById('viewReader');
            const library = document.getElementById('viewLibrary');
            const tabR = document.getElementById('tabReader');
            const tabL = document.getElementById('tabLibrary');
            reader.classList.toggle('hidden', tab !== 'reader');
            library.classList.toggle('hidden', tab !== 'library');
            tabR.className = tab === 'reader' ? "flex-1 py-2 rounded-xl font-bold text-[10px] sm:text-xs active-tab transition-all flex items-center justify-center gap-2" : "flex-1 py-2 rounded-xl font-bold text-[10px] sm:text-xs text-slate-400 transition-all flex items-center justify-center gap-2";
            tabL.className = tab === 'library' ? "flex-1 py-2 rounded-xl font-bold text-[10px] sm:text-xs active-tab transition-all flex items-center justify-center gap-2" : "flex-1 py-2 rounded-xl font-bold text-[10px] sm:text-xs text-slate-400 transition-all flex items-center justify-center gap-2";
        }

        textContent.addEventListener('input', updateWordCount);
        speedRange.oninput = () => speedValue.textContent = speedRange.value + "x";

        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';
        document.getElementById('fileInput').addEventListener('change', async (e) => {
            const f = e.target.files[0];
            if (!f) return;
            if (f.type === "application/pdf") {
                try {
                    const ab = await f.arrayBuffer();
                    currentPdf = await pdfjsLib.getDocument(ab).promise;
                    document.getElementById('pdfRangePanel').classList.remove('hidden');
                    document.getElementById('pdfInfoLabel').textContent = `${currentPdf.numPages} páginas totales`;
                    document.getElementById('startPage').value = 1;
                    document.getElementById('endPage').value = currentPdf.numPages;
                    processPdfRange();
                } catch (e) {
                    showToast("Error al abrir PDF", true);
                }
            } else {
                const r = new FileReader();
                r.onload = (ev) => {
                    textContent.innerText = ev.target.result;
                    document.getElementById('pdfRangePanel').classList.add('hidden');
                    updateWordCount();
                };
                r.readAsText(f);
            }
        });
    </script>
</body>
</html>